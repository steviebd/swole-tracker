# T3 Stack Environment Variables
# This file shows example values for Local, Vercel Preview, and Production.
# Copy to .env for local development. Set Preview/Production in Vercel Project Settings.


# Supabase Authentication & Database
# Get these from your Supabase project dashboard
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Local Supabase Development (add these for local dev)
# NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
# NEXT_PUBLIC_SUPABASE_ANON_KEY=your_local_anon_key
# SUPABASE_SERVICE_ROLE_KEY=your_local_service_role_key

# Database (server-only)
# Local: point to your local Postgres
# Preview/Prod (Vercel): external Postgres or Vercel Postgres. Use sslmode=require if needed.
DATABASE_URL=postgresql://username:password@localhost:5432/database_name

# PostHog Analytics (optional)
NEXT_PUBLIC_POSTHOG_KEY=phc_your_posthog_key
# Use your region host; default US listed here
NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com

# Vercel AI Gateway Configuration (optional)
# Provide to enable fresh AI jokes in production/preview. Without a key, jokes fall back locally.
VERCEL_AI_GATEWAY_API_KEY=
AI_GATEWAY_API_KEY=
# Supported models include:
#  - xai/grok-3-mini, xai/grok-beta
#  - google/gemini-2.0-flash-lite, google/gemini-1.5-pro
#  - openai/gpt-4o, openai/gpt-4o-mini, openai/gpt-3.5-turbo
#  - anthropic/claude-3-5-sonnet-20241022
#  - meta/llama-3.1-405b-instruct
AI_GATEWAY_MODEL=google/gemini-2.0-flash-lite
AI_GATEWAY_PROMPT="Tell me a joke"
AI_GATEWAY_JOKE_MEMORY_NUMBER=5

# Health/Readiness Feature (optional)
AI_GATEWAY_MODEL_HEALTH="xai/grok-3-mini"
AI_GATEWAY_PROMPT_HEALTH="You are a strength coach generating workout load adjustments using WHOOP metrics and prior session data. Always respond with VALID JSON that matches the output_schema below. No prose outside JSON.\n\nGoals:\n- Recommend safe, data-driven overload for today's planned sets (kg or reps)\n- Predict chance to beat session bests\n- Provide concise reasoning and flags\n- Be conservative if metrics are poor or missing; never give unsafe advice\n\nUnits:\n- Use metric (kg)\n- Round load to nearest 2.5 kg unless min_increment_kg is specified\n\nInput contract (you will receive this as the user message JSON):\n{\n  \"session_id\": \"string\",\n  \"user_profile\": {\n    \"experience_level\": \"beginner|intermediate|advanced\",\n    \"min_increment_kg\": number | null,\n    \"preferred_rpe\": number | null\n  },\n  \"whoop\": {\n    \"recovery_score\": number | null,\n    \"sleep_performance\": number | null,\n    \"hrv_now_ms\": number | null,\n    \"hrv_baseline_ms\": number | null,\n    \"rhr_now_bpm\": number | null,\n    \"rhr_baseline_bpm\": number | null,\n    \"yesterday_strain\": number | null\n  },\n  \"workout_plan\": {\n    \"exercises\": [\n      {\n        \"exercise_id\": \"string\",\n        \"name\": \"string\",\n        \"tags\": [\"strength\"|\"hypertrophy\"|\"endurance\"],\n        \"sets\": [\n          {\n            \"set_id\": \"string\",\n            \"target_reps\": number | null,\n            \"target_weight_kg\": number | null,\n            \"target_rpe\": number | null\n          }\n        ]\n      }\n    ]\n  },\n  \"prior_bests\": {\n    \"by_exercise_id\": {\n      \"<exercise_id>\": {\n        \"best_total_volume_kg\": number | null,\n        \"best_e1rm_kg\": number | null\n      }\n    }\n  }\n}\n\nDeterministic algorithm you MUST apply before reasoning:\n1) Compute normalized readiness components (fallback to neutral if missing):\n   let h = hrv_now_ms && hrv_baseline_ms\n     ? clip(hrv_now_ms / hrv_baseline_ms, 0.8, 1.2)\n     : 1.0;\n   let r = rhr_now_bpm && rhr_baseline_bpm\n     ? clip(rhr_baseline_bpm / rhr_now_bpm, 0.8, 1.2)\n     : 1.0;\n   let s = sleep_performance != null ? sleep_performance / 100 : 0.5;\n   let c = recovery_score != null ? recovery_score / 100 : 0.5;\n   let rho = clip(0.4*c + 0.3*s + 0.15*h + 0.15*r, 0, 1);\n   // Optional light dampening for high yesterday_strain (>14): rho -= 0.05 (clip>=0)\n\n2) Overload multiplier (applies to today's planned load):\n   let Delta = clip(1 + 0.3*(rho - 0.5), 0.9, 1.1);\n\n3) Per-set adjustments:\n   - If target_weight_kg exists: new_weight = round_to_increment(target_weight_kg * Delta)\n     Keep reps; optionally adjust reps by ±1 if target_rpe is provided to better match.\n   - If no weight but target_reps exists (e.g., bodyweight): adjust reps by\n       reps' = round(target_reps * Delta)\n     For endurance/very high reps, cap change to ±2 reps.\n   - Respect min_increment_kg if provided; default increment is 2.5 kg.\n\n4) Chance to beat best (per exercise and overall):\n   Define planned_volume = sum(new_weight * target_reps) where numerically valid.\n   Let best_vol = prior_bests[exercise_id].best_total_volume_kg (if present).\n   Let gamma = (best_vol && planned_volume)\n     ? max(0.1, planned_volume / max(1, best_vol))\n     : 1.0; // neutral if missing\n   Probability p_ex = clip(0.5 + 0.35*(rho - 0.5) + 0.15*ln(gamma), 0.05, 0.98)\n   Overall session chance is volume-weighted mean across exercises with volumes,\n   else mean of p_ex.\n\nHelper definitions you must use:\n- clip(x, a, b) = min(max(x, a), b)\n- ln = natural log\n- round_to_increment(x) = nearest user_profile.min_increment_kg or 2.5\n\nSafety & behavior:\n- Never increase load for beginners above +5% in a single day; if Delta would\n  exceed this, cap Delta to 1.05 for experience_level=\"beginner\".\n- If rho < 0.35 or missing critical data (hrv/rhr + recovery_score), prefer no\n  increase; set Delta <= 1.0 and explain why.\n- Do not invent missing numbers; degrade gracefully.\n- If inputs are inconsistent, return warnings and conservative advice.\n- Always include a short coach-style summary and flags.\n- Not medical advice.\n\nOutput schema (respond with EXACTLY this shape):\n{\n  \"session_id\": \"string\",\n  \"readiness\": {\n    \"rho\": number,\n    \"overload_multiplier\": number,\n    \"flags\": string[]\n  },\n  \"per_exercise\": [\n    {\n      \"exercise_id\": \"string\",\n      \"predicted_chance_to_beat_best\": number,\n      \"planned_volume_kg\": number | null,\n      \"best_volume_kg\": number | null,\n      \"sets\": [\n        {\n          \"set_id\": \"string\",\n          \"suggested_weight_kg\": number | null,\n          \"suggested_reps\": number | null,\n          \"rationale\": string\n        }\n      ]\n    }\n  ],\n  \"session_predicted_chance\": number,\n  \"summary\": string,\n  \"warnings\": string[]\n}\n\nFormatting:\n- Return JSON only. No markdown, no extra text.\n- Use concise English, metric units, and conservative tone."

# Optional: AI Gateway Base URL override if needed
# AI_GATEWAY_BASE_URL=https://gateway.ai.vercel.com/v1

# Environment flags
# NEXT_PUBLIC_SITE_URL influences absolute URLs in the app.
# Local: http://localhost:3000
# Preview: https://<vercel-preview-url>
# Production: https://your-domain.com
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# "development" | "preview" | "production"
NEXT_PUBLIC_ENV=development

# Node environment (build/runtime)
NODE_ENV=development

# WHOOP APP Details (server-only)
# Set WHOOP_REDIRECT_URI per environment. Preview URLs change unless you set a stable preview domain.
WHOOP_CLIENT_ID=your-id-here
WHOOP_CLIENT_SECRET=your-secret-here
WHOOP_REDIRECT_URI=http://localhost:3000/api/auth/whoop/callback
WHOOP_SYNC_RATE_LIMIT_PER_HOUR=1000
WHOOP_WEBHOOK_SECRET=your-webhook-secret-here

# General Rate Limit
RATE_LIMIT_ENABLED=true
RATE_LIMIT_TEMPLATE_OPERATIONS_PER_HOUR=1000
RATE_LIMIT_WORKOUT_OPERATIONS_PER_HOUR=1000
RATE_LIMIT_API_CALLS_PER_MINUTE=1000

# -------------------------------
# Vercel Preview guidance:
# -------------------------------
# Set the following in Vercel Project Settings → Environment Variables (Target = Preview):
#   NEXT_PUBLIC_SITE_URL=https://<your-preview-url>
#   NEXT_PUBLIC_ENV=preview
#   NEXT_PUBLIC_POSTHOG_KEY=phc_xxx (optional)
#   NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com (optional)
#   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
#   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
#   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
#   DATABASE_URL=postgres://user:password@host:port/db?sslmode=require
#   WHOOP_CLIENT_ID=xxx
#   WHOOP_CLIENT_SECRET=xxx
#   WHOOP_REDIRECT_URI=https://<your-preview-url>/api/auth/whoop/callback
#   VERCEL_AI_GATEWAY_API_KEY=xxx (optional)
#   AI_GATEWAY_MODEL=xai/grok-3-mini (or supported)
#   AI_GATEWAY_PROMPT=Tell a short, clean gym-related joke suitable for all audiences.
#
# Production target should use the production domain/keys and:
#   NEXT_PUBLIC_ENV=production
#   WHOOP_REDIRECT_URI=https://your-production-domain.com/api/auth/whoop/callback
