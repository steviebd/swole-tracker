# Supabase Production Migration Plan

## Current Status
- ✅ Local schema is up to date with `dailyJokes` table
- ✅ Migration `0001_yummy_malcolm_colcord.sql` has been generated
- ⚠️  Need to verify if migration was applied to production

## Migration Overview

The latest migration (`0001_yummy_malcolm_colcord.sql`) includes:

### 1. New Table: `swole-tracker_daily_joke`
```sql
CREATE TABLE "swole-tracker_daily_joke" (
  "id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_id" varchar(256) NOT NULL,
  "joke" text NOT NULL,
  "aiModel" varchar(100) NOT NULL,
  "prompt" text NOT NULL,
  "createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

### 2. Column Renames (userId → user_id)
- `swole-tracker_session_exercise.userId` → `user_id`
- `swole-tracker_template_exercise.userId` → `user_id`
- `swole-tracker_user_preferences.userId` → `user_id`
- `swole-tracker_workout_session.userId` → `user_id`
- `swole-tracker_workout_template.userId` → `user_id`

### 3. Index Updates
- Drops old indexes referencing `userId`
- Creates new indexes for `user_id` columns
- Adds specific indexes for `dailyJokes` table

## Deployment Steps

### Option 1: Using Drizzle Push (Recommended)
```bash
# This applies all pending migrations to production
pnpm db:push
```

### Option 2: Manual Migration via Supabase Dashboard
1. Go to Supabase Dashboard → SQL Editor
2. Run the migration SQL manually:

```sql
-- Create the daily jokes table if it doesn't exist
CREATE TABLE IF NOT EXISTS "swole-tracker_daily_joke" (
  "id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_id" varchar(256) NOT NULL,
  "joke" text NOT NULL,
  "aiModel" varchar(100) NOT NULL,
  "prompt" text NOT NULL,
  "createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- Create indexes for daily jokes
CREATE INDEX IF NOT EXISTS "daily_joke_user_id_idx" ON "swole-tracker_daily_joke" USING btree ("user_id");
CREATE INDEX IF NOT EXISTS "daily_joke_created_at_idx" ON "swole-tracker_daily_joke" USING btree ("createdAt");
CREATE INDEX IF NOT EXISTS "daily_joke_user_date_idx" ON "swole-tracker_daily_joke" USING btree ("user_id","createdAt");
```

### Option 3: Using Drizzle Migrate (Most Control)
```bash
# Generate migration files
pnpm db:generate

# Apply specific migration
pnpm db:migrate
```

## Verification Steps

### 1. Check Table Exists
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name = 'swole-tracker_daily_joke';
```

### 2. Verify Schema
```sql
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'swole-tracker_daily_joke'
ORDER BY ordinal_position;
```

### 3. Check Indexes
```sql
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'swole-tracker_daily_joke';
```

### 4. Test Application
- Load the joke component
- Verify no "relation does not exist" errors
- Check that jokes are being stored in database

## Rollback Plan (If Needed)

```sql
-- Drop the daily jokes table
DROP TABLE IF EXISTS "swole-tracker_daily_joke";

-- Note: Column renames would need individual rollback statements
-- Only run if you need to revert completely
```

## Post-Migration Tasks

1. **Verify Data Integrity**
   - Check that existing workout data is intact
   - Verify user_id references are working correctly

2. **Test Functionality**
   - Test joke generation and caching
   - Verify 20-hour refresh logic
   - Test login-based cache clearing

3. **Monitor Performance**
   - Check query performance on new indexes
   - Monitor daily joke table growth

## Environment Variables Required

Ensure these are set in your Supabase/Vercel environment:

```bash
VERCEL_AI_GATEWAY_API_KEY=your_ai_gateway_key
AI_GATEWAY_MODEL=xai/grok-3-mini
AI_GATEWAY_PROMPT="Tell me a short, funny programming or tech joke. Keep it clean and under 100 words."
```

## Current Migration Status

Run this command to check what's been applied:

```bash
# Check current schema against production
pnpm db:push --dry-run
```

If it shows "Changes applied" or "No changes", you're good to go!
