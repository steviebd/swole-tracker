(()=>{var a={};a.id=9556,a.ids=[9556],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},37478:(a,b,c)=>{"use strict";c.d(b,{E:()=>g});var d=c(31553),e=c(30314),f=c(48689);async function g(a,b,c,h=36e5){let i=new Date,j=new Date(Math.floor(i.getTime()/h)*h),k=new Date(j.getTime()+h),[l]=await d.db.select().from(e.rateLimits).where((0,f.Uo)((0,f.eq)(e.rateLimits.user_id,a),(0,f.eq)(e.rateLimits.endpoint,b),(0,f.eq)(e.rateLimits.windowStart,j.toISOString())));if(!l)return await d.db.insert(e.rateLimits).values({user_id:a,endpoint:b,requests:1,windowStart:j.toISOString()}),{allowed:!0,remaining:c-1,resetTime:k};if(l.requests>=c){let a=Math.ceil((k.getTime()-i.getTime())/1e3);return{allowed:!1,remaining:0,resetTime:k,retryAfter:a}}return await d.db.update(e.rateLimits).set({requests:l.requests+1,updatedAt:new Date}).where((0,f.eq)(e.rateLimits.id,l.id)),{allowed:!0,remaining:c-l.requests-1,resetTime:k}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50919:(a,b,c)=>{"use strict";c.d(b,{g_:()=>i,rE:()=>g});let d="AES-GCM";async function e(a,b){let c=new TextEncoder,e=await crypto.subtle.importKey("raw",c.encode(a),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:b.buffer,iterations:1e5,hash:"SHA-256"},e,{name:d,length:256},!1,["encrypt","decrypt"])}function f(){let a=process.env.ENCRYPTION_MASTER_KEY;if(!a)throw Error("ENCRYPTION_MASTER_KEY environment variable is required for token encryption");if(a.length<32)throw Error("ENCRYPTION_MASTER_KEY must be at least 32 characters long");return a}async function g(a){try{let b=f(),c=crypto.getRandomValues(new Uint8Array(32)),g=crypto.getRandomValues(new Uint8Array(16)),h=await e(b,c),i=new TextEncoder().encode(a),j=await crypto.subtle.encrypt({name:d,iv:g},h,i),k=j.slice(0,-16),l=j.slice(-16),m=new Uint8Array([...c,...g,...new Uint8Array(l),...new Uint8Array(k)]);return btoa(String.fromCharCode(...m))}catch(a){if(console.error("Token encryption failed:",a),a instanceof Error)throw a;throw Error("Failed to encrypt token")}}async function h(a){try{let b=f(),c=new Uint8Array(atob(a).split("").map(a=>a.charCodeAt(0))),g=c.subarray(0,32),h=c.subarray(32,48),i=c.subarray(48,64),j=c.subarray(64),k=await e(b,g),l=new Uint8Array([...j,...i]),m=await crypto.subtle.decrypt({name:d,iv:h},k,l);return new TextDecoder().decode(m)}catch(a){if(console.error("Token decryption failed:",a),a instanceof Error)throw a;throw Error("Failed to decrypt token")}}async function i(a){return!function(a){try{return Buffer.from(a,"base64").length>=65}catch{return!1}}(a)?a:h(a)}},58511:(a,b,c)=>{"use strict";c.d(b,{x:()=>i});var d=c(8579);let e="workos_session",f="production"===d._.NODE_ENV;async function g(a){let b=function(){let a=d._.WORKER_SESSION_SECRET;if(!a||a.length<32)throw Error("WORKER_SESSION_SECRET must be at least 32 characters long");return a}(),c=new TextEncoder,e=await crypto.subtle.importKey("raw",c.encode(b),{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return Array.from(new Uint8Array(await crypto.subtle.sign("HMAC",e,c.encode(a)))).map(a=>a.toString(16).padStart(2,"0")).join("")}async function h(a,b){return await g(a)===b}class i{static async create(a){let b=JSON.stringify({...a,refreshToken:a.refreshToken??null}),c=await g(b),d=`${b}.${c}`;return[`${e}=${encodeURIComponent(d)}`,"Max-Age=2592000","Path=/","HttpOnly",f?"Secure":"","SameSite=lax"].filter(Boolean).join("; ")}static async get(a){let b=a.headers.get("cookie");if(!b)return null;let c=this.extractCookieValue(b,e);if(!c)return null;try{let a=decodeURIComponent(c),b=a.lastIndexOf(".");if(b<=0||b===a.length-1)return null;let d=a.slice(0,b),e=a.slice(b+1);if(!await h(d,e))return null;try{let a=JSON.parse(d);if(!a.userId||!a.accessToken||!a.expiresAt)throw Error("Invalid session data");let b=void 0===a.refreshToken?null:a.refreshToken;return{...a,refreshToken:b}}catch(a){throw Error("Invalid session data format")}}catch(a){return null}}static destroy(){return[`${e}=`,"Max-Age=0","Path=/","HttpOnly",f?"Secure":"","SameSite=lax"].filter(Boolean).join("; ")}static extractCookieValue(a,b){for(let c of a.split(";").map(a=>a.trim()))if(c.startsWith(`${b}=`))return c.substring(`${b}=`.length);return null}static async hasSession(a){return null!==await this.get(a)}static isExpired(a){let b=Math.floor(Date.now()/1e3);return a.expiresAt<=b}}},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},72143:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{POST:()=>E,runtime:()=>D});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(58511),w=c(31553),x=c(30314),y=c(48689),z=c(71559),A=c(8579),B=c(37478),C=c(87652);let D="nodejs";async function E(a){try{let b=await v.x.get(a);if(!b||v.x.isExpired(b))return u.NextResponse.json({error:"Unauthorized"},{status:401});let c=await (0,B.E)(b.userId,"whoop_sync",A._.WHOOP_SYNC_RATE_LIMIT_PER_HOUR,36e5);if(!c.allowed)return u.NextResponse.json({error:"Rate limit exceeded",message:`You can only sync ${A._.WHOOP_SYNC_RATE_LIMIT_PER_HOUR} times per hour. Try again in ${Math.ceil(c.retryAfter/60)} minutes.`,retryAfter:c.retryAfter,resetTime:c.resetTime.toISOString()},{status:429,headers:{"Retry-After":c.retryAfter.toString(),"X-RateLimit-Limit":A._.WHOOP_SYNC_RATE_LIMIT_PER_HOUR.toString(),"X-RateLimit-Remaining":c.remaining.toString(),"X-RateLimit-Reset":Math.floor(c.resetTime.getTime()/1e3).toString()}});let d=await (0,C.uX)(b.userId,"whoop");if(!d.token)return u.NextResponse.json({error:d.error||"Whoop integration not found or token invalid"},{status:404});let e=d.token,[f]=await w.db.select({start:x.externalWorkoutsWhoop.start}).from(x.externalWorkoutsWhoop).where((0,y.eq)(x.externalWorkoutsWhoop.user_id,b.userId)).orderBy((0,z.i)(x.externalWorkoutsWhoop.start)).limit(1),g="https://api.prod.whoop.com/developer/v2/activity/workout?limit=25";if(f?.start){let a=new Date(f.start).toISOString();g+=`&since=${encodeURIComponent(a)}`}let h=await fetch(g,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!h.ok){let a=await h.text();return console.error("Whoop API error:",h.status,a),u.NextResponse.json({error:`Whoop API error: ${h.status} - ${a}`},{status:h.status})}let i=await h.json();if("object"!=typeof i||null===i)return u.NextResponse.json({error:"Unexpected Whoop API response shape"},{status:502});let j=i.data,k=i.records;console.log("Whoop API response structure:",{keys:Object.keys(i),recordsLength:Array.isArray(k)?k.length:void 0,dataLength:Array.isArray(j)?j.length:void 0});let l=(Array.isArray(j)?j:Array.isArray(k)?k:[]).map(a=>({id:String(a.id??""),start:String(a.start??""),end:String(a.end??""),timezone_offset:String(a.timezone_offset??""),sport_name:String(a.sport_name??""),score_state:String(a.score_state??""),score:a.score,during:a.during,zone_duration:a.zone_duration})),m=await w.db.select({whoopWorkoutId:x.externalWorkoutsWhoop.whoopWorkoutId,start:x.externalWorkoutsWhoop.start,end:x.externalWorkoutsWhoop.end}).from(x.externalWorkoutsWhoop).where((0,y.eq)(x.externalWorkoutsWhoop.user_id,b.userId)),n=new Set(m.map(a=>a.whoopWorkoutId)),o=new Set(m.map(a=>`${a.start.toISOString()}_${a.end.toISOString()}`)),p=l.filter(a=>{let b=`${new Date(a.start).toISOString()}_${new Date(a.end).toISOString()}`;return!n.has(a.id)&&!o.has(b)}),q=0,r=l.length-p.length;if(p.length>0)try{let a=p.map(a=>({user_id:b.userId,whoopWorkoutId:a.id,start:new Date(a.start),end:new Date(a.end),timezone_offset:a.timezone_offset,sport_name:a.sport_name,score_state:a.score_state,score:a.score?JSON.stringify(a.score):null,during:a.during?JSON.stringify(a.during):null,zone_duration:a.zone_duration?JSON.stringify(a.zone_duration):null}));await w.db.insert(x.externalWorkoutsWhoop).values(a),q=p.length}catch(a){for(let c of(console.error("Error during batch insert, falling back to individual inserts:",a),p))try{await w.db.insert(x.externalWorkoutsWhoop).values({user_id:b.userId,whoopWorkoutId:c.id,start:new Date(c.start),end:new Date(c.end),timezone_offset:c.timezone_offset,sport_name:c.sport_name,score_state:c.score_state,score:c.score?JSON.stringify(c.score):null,during:c.during?JSON.stringify(c.during):null,zone_duration:c.zone_duration?JSON.stringify(c.zone_duration):null}),q++}catch(a){console.error(`Error processing workout ${c.id}:`,a)}}return u.NextResponse.json({success:!0,totalWorkouts:l.length,newWorkouts:q,duplicates:r,rateLimit:{remaining:c.remaining,resetTime:c.resetTime.toISOString()}},{headers:{"X-RateLimit-Limit":A._.WHOOP_SYNC_RATE_LIMIT_PER_HOUR.toString(),"X-RateLimit-Remaining":c.remaining.toString(),"X-RateLimit-Reset":Math.floor(c.resetTime.getTime()/1e3).toString()}})}catch(a){return console.error("Sync workouts error:",a),u.NextResponse.json({error:a instanceof Error?a.message:"Failed to sync workouts"},{status:500})}}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/whoop/sync-workouts/route",pathname:"/api/whoop/sync-workouts",filename:"route",bundlePath:"app/api/whoop/sync-workouts/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/steven/swole-tracker/src/app/api/whoop/sync-workouts/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/whoop/sync-workouts/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},78335:()=>{},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87652:(a,b,c)=>{"use strict";c.d(b,{uX:()=>l});var d=c(31553),e=c(30314),f=c(48689),g=c(8579),h=c(50919);async function i(a,b){try{let[c]=await d.db.select().from(e.userIntegrations).where((0,f.Uo)((0,f.eq)(e.userIntegrations.user_id,a),(0,f.eq)(e.userIntegrations.provider,b),(0,f.eq)(e.userIntegrations.isActive,!0)));if(!c)return{success:!1,error:"Integration not found"};if(!c.refreshToken)return{success:!1,error:"No refresh token available"};if(!function(a,b,c=!1){if(c)return!0;let d=new Date;return!!(a&&a.getTime()-d.getTime()<864e5||b&&d.getTime()-b.getTime()>6048e5)}(c.expiresAt||null,c.updatedAt||null))return{success:!0,newAccessToken:await (0,h.g_)(c.accessToken)};let g=await (0,h.g_)(c.refreshToken),i=await j(b,g);if(!i.success||!i.accessToken)return{success:!1,error:i.error};let k=await (0,h.rE)(i.accessToken),l=i.refreshToken?await (0,h.rE)(i.refreshToken):c.refreshToken,m=i.expiresIn?new Date(Date.now()+1e3*i.expiresIn):c.expiresAt;return await d.db.update(e.userIntegrations).set({accessToken:k,refreshToken:l,expiresAt:m,updatedAt:new Date}).where((0,f.eq)(e.userIntegrations.id,c.id)),{success:!0,newAccessToken:i.accessToken}}catch(c){return console.error("Token rotation failed:",{userId:a.substring(0,8)+"...",provider:b,error:c instanceof Error?c.message:"Unknown error"}),{success:!1,error:c instanceof Error?c.message:"Token rotation failed"}}}async function j(a,b){return"whoop"===a.toLowerCase()?await k(b):{success:!1,error:`Unsupported provider: ${a}`}}async function k(a){try{if(!g._.WHOOP_CLIENT_ID||!g._.WHOOP_CLIENT_SECRET)return{success:!1,error:"WHOOP credentials not configured"};let b={grant_type:"refresh_token",refresh_token:a,client_id:g._.WHOOP_CLIENT_ID,client_secret:g._.WHOOP_CLIENT_SECRET},c=await fetch("https://api.prod.whoop.com/oauth/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams(b).toString()});if(!c.ok)return{success:!1,error:`WHOOP token refresh failed: ${c.status} - ${c.statusText}`};let d=await c.json();if(!d.access_token)return{success:!1,error:"No access token in response"};return{success:!0,accessToken:d.access_token,refreshToken:d.refresh_token,expiresIn:d.expires_in}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Token refresh failed"}}}async function l(a,b){try{let c=await i(a,b);if(c.success&&c.newAccessToken)return{token:c.newAccessToken};return{token:null,error:c.error}}catch(a){return{token:null,error:a instanceof Error?a.message:"Failed to get valid token"}}}},96487:()=>{}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[5873,1428,3708,7639,1692,1553],()=>b(b.s=72143));module.exports=c})();