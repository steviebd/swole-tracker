(()=>{var a={};a.id=2061,a.ids=[2061],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},37478:(a,b,c)=>{"use strict";c.d(b,{E:()=>g});var d=c(31553),e=c(30314),f=c(48689);async function g(a,b,c,h=36e5){let i=new Date,j=new Date(Math.floor(i.getTime()/h)*h),k=new Date(j.getTime()+h),[l]=await d.db.select().from(e.rateLimits).where((0,f.Uo)((0,f.eq)(e.rateLimits.user_id,a),(0,f.eq)(e.rateLimits.endpoint,b),(0,f.eq)(e.rateLimits.windowStart,j.toISOString())));if(!l)return await d.db.insert(e.rateLimits).values({user_id:a,endpoint:b,requests:1,windowStart:j.toISOString()}),{allowed:!0,remaining:c-1,resetTime:k};if(l.requests>=c){let a=Math.ceil((k.getTime()-i.getTime())/1e3);return{allowed:!1,remaining:0,resetTime:k,retryAfter:a}}return await d.db.update(e.rateLimits).set({requests:l.requests+1,updatedAt:new Date}).where((0,f.eq)(e.rateLimits.id,l.id)),{allowed:!0,remaining:c-l.requests-1,resetTime:k}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50919:(a,b,c)=>{"use strict";c.d(b,{g_:()=>i,rE:()=>g});let d="AES-GCM";async function e(a,b){let c=new TextEncoder,e=await crypto.subtle.importKey("raw",c.encode(a),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:b.buffer,iterations:1e5,hash:"SHA-256"},e,{name:d,length:256},!1,["encrypt","decrypt"])}function f(){let a=process.env.ENCRYPTION_MASTER_KEY;if(!a)throw Error("ENCRYPTION_MASTER_KEY environment variable is required for token encryption");if(a.length<32)throw Error("ENCRYPTION_MASTER_KEY must be at least 32 characters long");return a}async function g(a){try{let b=f(),c=crypto.getRandomValues(new Uint8Array(32)),g=crypto.getRandomValues(new Uint8Array(16)),h=await e(b,c),i=new TextEncoder().encode(a),j=await crypto.subtle.encrypt({name:d,iv:g},h,i),k=j.slice(0,-16),l=j.slice(-16),m=new Uint8Array([...c,...g,...new Uint8Array(l),...new Uint8Array(k)]);return btoa(String.fromCharCode(...m))}catch(a){if(console.error("Token encryption failed:",a),a instanceof Error)throw a;throw Error("Failed to encrypt token")}}async function h(a){try{let b=f(),c=new Uint8Array(atob(a).split("").map(a=>a.charCodeAt(0))),g=c.subarray(0,32),h=c.subarray(32,48),i=c.subarray(48,64),j=c.subarray(64),k=await e(b,g),l=new Uint8Array([...j,...i]),m=await crypto.subtle.decrypt({name:d,iv:h},k,l);return new TextDecoder().decode(m)}catch(a){if(console.error("Token decryption failed:",a),a instanceof Error)throw a;throw Error("Failed to decrypt token")}}async function i(a){return!function(a){try{return Buffer.from(a,"base64").length>=65}catch{return!1}}(a)?a:h(a)}},58511:(a,b,c)=>{"use strict";c.d(b,{x:()=>i});var d=c(8579);let e="workos_session",f="production"===d._.NODE_ENV;async function g(a){let b=function(){let a=d._.WORKER_SESSION_SECRET;if(!a||a.length<32)throw Error("WORKER_SESSION_SECRET must be at least 32 characters long");return a}(),c=new TextEncoder,e=await crypto.subtle.importKey("raw",c.encode(b),{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return Array.from(new Uint8Array(await crypto.subtle.sign("HMAC",e,c.encode(a)))).map(a=>a.toString(16).padStart(2,"0")).join("")}async function h(a,b){return await g(a)===b}class i{static async create(a){let b=JSON.stringify({...a,refreshToken:a.refreshToken??null}),c=await g(b),d=`${b}.${c}`;return[`${e}=${encodeURIComponent(d)}`,"Max-Age=2592000","Path=/","HttpOnly",f?"Secure":"","SameSite=lax"].filter(Boolean).join("; ")}static async get(a){let b=a.headers.get("cookie");if(!b)return null;let c=this.extractCookieValue(b,e);if(!c)return null;try{let a=decodeURIComponent(c),b=a.lastIndexOf(".");if(b<=0||b===a.length-1)return null;let d=a.slice(0,b),e=a.slice(b+1);if(!await h(d,e))return null;try{let a=JSON.parse(d);if(!a.userId||!a.accessToken||!a.expiresAt)throw Error("Invalid session data");let b=void 0===a.refreshToken?null:a.refreshToken;return{...a,refreshToken:b}}catch(a){throw Error("Invalid session data format")}}catch(a){return null}}static destroy(){return[`${e}=`,"Max-Age=0","Path=/","HttpOnly",f?"Secure":"","SameSite=lax"].filter(Boolean).join("; ")}static extractCookieValue(a,b){for(let c of a.split(";").map(a=>a.trim()))if(c.startsWith(`${b}=`))return c.substring(`${b}=`.length);return null}static async hasSession(a){return null!==await this.get(a)}static isExpired(a){let b=Math.floor(Date.now()/1e3);return a.expiresAt<=b}}},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87652:(a,b,c)=>{"use strict";c.d(b,{uX:()=>l});var d=c(31553),e=c(30314),f=c(48689),g=c(8579),h=c(50919);async function i(a,b){try{let[c]=await d.db.select().from(e.userIntegrations).where((0,f.Uo)((0,f.eq)(e.userIntegrations.user_id,a),(0,f.eq)(e.userIntegrations.provider,b),(0,f.eq)(e.userIntegrations.isActive,!0)));if(!c)return{success:!1,error:"Integration not found"};if(!c.refreshToken)return{success:!1,error:"No refresh token available"};if(!function(a,b,c=!1){if(c)return!0;let d=new Date;return!!(a&&a.getTime()-d.getTime()<864e5||b&&d.getTime()-b.getTime()>6048e5)}(c.expiresAt||null,c.updatedAt||null))return{success:!0,newAccessToken:await (0,h.g_)(c.accessToken)};let g=await (0,h.g_)(c.refreshToken),i=await j(b,g);if(!i.success||!i.accessToken)return{success:!1,error:i.error};let k=await (0,h.rE)(i.accessToken),l=i.refreshToken?await (0,h.rE)(i.refreshToken):c.refreshToken,m=i.expiresIn?new Date(Date.now()+1e3*i.expiresIn):c.expiresAt;return await d.db.update(e.userIntegrations).set({accessToken:k,refreshToken:l,expiresAt:m,updatedAt:new Date}).where((0,f.eq)(e.userIntegrations.id,c.id)),{success:!0,newAccessToken:i.accessToken}}catch(c){return console.error("Token rotation failed:",{userId:a.substring(0,8)+"...",provider:b,error:c instanceof Error?c.message:"Unknown error"}),{success:!1,error:c instanceof Error?c.message:"Token rotation failed"}}}async function j(a,b){return"whoop"===a.toLowerCase()?await k(b):{success:!1,error:`Unsupported provider: ${a}`}}async function k(a){try{if(!g._.WHOOP_CLIENT_ID||!g._.WHOOP_CLIENT_SECRET)return{success:!1,error:"WHOOP credentials not configured"};let b={grant_type:"refresh_token",refresh_token:a,client_id:g._.WHOOP_CLIENT_ID,client_secret:g._.WHOOP_CLIENT_SECRET},c=await fetch("https://api.prod.whoop.com/oauth/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams(b).toString()});if(!c.ok)return{success:!1,error:`WHOOP token refresh failed: ${c.status} - ${c.statusText}`};let d=await c.json();if(!d.access_token)return{success:!1,error:"No access token in response"};return{success:!0,accessToken:d.access_token,refreshToken:d.refresh_token,expiresIn:d.expires_in}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Token refresh failed"}}}async function l(a,b){try{let c=await i(a,b);if(c.success&&c.newAccessToken)return{token:c.newAccessToken};return{token:null,error:c.error}}catch(a){return{token:null,error:a instanceof Error?a.message:"Failed to get valid token"}}}},92959:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>Q,patchFetch:()=>P,routeModule:()=>L,serverHooks:()=>O,workAsyncStorage:()=>M,workUnitAsyncStorage:()=>N});var d={};c.r(d),c.d(d,{POST:()=>K,runtime:()=>C});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(58511),w=c(31553),x=c(30314),y=c(48689),z=c(71559),A=c(37478),B=c(87652);let C="nodejs";async function D(a,b,c=25,d){let e=`https://api.prod.whoop.com/developer/v2/${a}?limit=${c}`;if(d){let b=d.toISOString();e+=`&since=${encodeURIComponent(b)}`,console.log(`[WHOOP API v2] Incremental sync for ${a} since ${b}`)}let f=await fetch(e,{headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"}});if(!f.ok){let b=await f.text();console.error(`[WHOOP API v2] Error for ${a}: ${f.status} - ${b}`);let c=Error(`WHOOP API v2 error for ${a}: ${f.status} - ${b}`);throw c.status=f.status,c}let g=await f.json(),h=g.records||g||[];return console.log(`[WHOOP API v2] Successfully fetched ${h.length} records from ${a}${d?` (since ${d.toISOString()})`:""}`),h}async function E(a,b){try{let[c]=await w.db.select({start:x.externalWorkoutsWhoop.start}).from(x.externalWorkoutsWhoop).where((0,y.eq)(x.externalWorkoutsWhoop.user_id,a)).orderBy((0,z.i)(x.externalWorkoutsWhoop.start)).limit(1),d=c?.start?new Date(c.start):void 0,e=await D("activity/workout",b,25,d);if(0===e.length)return 0;let f=await w.db.select({whoopWorkoutId:x.externalWorkoutsWhoop.whoopWorkoutId,start:x.externalWorkoutsWhoop.start,end:x.externalWorkoutsWhoop.end}).from(x.externalWorkoutsWhoop).where((0,y.eq)(x.externalWorkoutsWhoop.user_id,a)),g=new Set(f.map(a=>a.whoopWorkoutId)),h=new Set(f.map(a=>`${a.start.toISOString()}_${a.end.toISOString()}`)),i=e.filter(a=>{let b=`${new Date(a.start).toISOString()}_${new Date(a.end).toISOString()}`;return!g.has(a.id)&&!h.has(b)});if(i.length>0)for(let b of i)try{await w.db.insert(x.externalWorkoutsWhoop).values([{user_id:a,whoopWorkoutId:b.id,start:new Date(b.start),end:new Date(b.end),timezone_offset:b.timezone_offset,sport_name:b.sport_name,score_state:b.score_state,score:b.score?JSON.stringify(b.score):null,during:b.during?JSON.stringify(b.during):null,zone_duration:b.zone_duration?JSON.stringify(b.zone_duration):null}]).onConflictDoNothing()}catch(a){console.log(`Skipping duplicate workout ${b.id}:`,a)}return i.length}catch(a){throw console.error("Error syncing workouts:",a),a}}async function F(a,b){try{console.log(`[Recovery Sync] Starting recovery sync for user ${a}`);let[c]=await w.db.select({webhook_received_at:x.whoopRecovery.webhook_received_at}).from(x.whoopRecovery).where((0,y.eq)(x.whoopRecovery.user_id,a)).orderBy((0,z.i)(x.whoopRecovery.webhook_received_at)).limit(1),d=c?.webhook_received_at?new Date(c.webhook_received_at):void 0,e=await D("recovery",b,25,d);if(console.log(`[Recovery Sync] Fetched ${e.length} recovery records from WHOOP API v2`),0===e.length)return console.log("[Recovery Sync] No recovery data returned from API"),0;let f=e.map(a=>a.sleep_id).filter(Boolean),g=await w.db.select({whoopRecoveryId:x.whoopRecovery.whoop_recovery_id}).from(x.whoopRecovery).where((0,y.Uo)((0,y.eq)(x.whoopRecovery.user_id,a),(0,y.RV)(x.whoopRecovery.whoop_recovery_id,f))),h=new Set(g.map(a=>a.whoopRecoveryId)),i=e.filter(a=>a.sleep_id&&!h.has(a.sleep_id));return i.length>0&&await w.db.insert(x.whoopRecovery).values(i.map(b=>{let c;return c=b.created_at&&"string"==typeof b.created_at&&b.created_at.split("T")[0]||new Date().toISOString().split("T")[0],{user_id:a,whoop_recovery_id:b.sleep_id,cycle_id:b.cycle_id?.toString()||null,date:new Date(c),recovery_score:b.score?.recovery_score||null,hrv_rmssd_milli:b.score?.hrv_rmssd_milli||null,hrv_rmssd_baseline:null,resting_heart_rate:b.score?.resting_heart_rate||null,resting_heart_rate_baseline:null,raw_data:JSON.stringify(b),timezone_offset:null}})).onConflictDoNothing(),i.length}catch(a){throw console.error("Error syncing recovery:",a),a}}async function G(a,b){try{let[c]=await w.db.select({start:x.whoopCycles.start}).from(x.whoopCycles).where((0,y.eq)(x.whoopCycles.user_id,a)).orderBy((0,z.i)(x.whoopCycles.start)).limit(1),d=c?.start?new Date(c.start):void 0,e=await D("cycle",b,25,d);if(0===e.length)return 0;let f=await w.db.select({whoopCycleId:x.whoopCycles.whoop_cycle_id}).from(x.whoopCycles).where((0,y.Uo)((0,y.eq)(x.whoopCycles.user_id,a),(0,y.RV)(x.whoopCycles.whoop_cycle_id,e.map(a=>a.id)))),g=new Set(f.map(a=>a.whoopCycleId)),h=e.filter(a=>!g.has(a.id));return h.length>0&&await w.db.insert(x.whoopCycles).values(h.map(b=>({user_id:a,whoop_cycle_id:b.id,start:new Date(b.start),end:new Date(b.end),timezone_offset:b.timezone_offset||null,day_strain:b.score?.strain||null,average_heart_rate:b.score?.average_heart_rate||null,max_heart_rate:b.score?.max_heart_rate||null,kilojoule:b.score?.kilojoule||null,raw_data:JSON.stringify(b)}))).onConflictDoNothing(),h.length}catch(a){throw console.error("Error syncing cycles:",a),a}}async function H(a,b){try{let[c]=await w.db.select({start:x.whoopSleep.start}).from(x.whoopSleep).where((0,y.eq)(x.whoopSleep.user_id,a)).orderBy((0,z.i)(x.whoopSleep.start)).limit(1),d=c?.start?new Date(c.start):void 0,e=await D("activity/sleep",b,25,d);if(0===e.length)return 0;let f=await w.db.select({whoopSleepId:x.whoopSleep.whoop_sleep_id}).from(x.whoopSleep).where((0,y.Uo)((0,y.eq)(x.whoopSleep.user_id,a),(0,y.RV)(x.whoopSleep.whoop_sleep_id,e.map(a=>a.id)))),g=new Set(f.map(a=>a.whoopSleepId)),h=e.filter(a=>!g.has(a.id));return h.length>0&&await w.db.insert(x.whoopSleep).values(h.map(b=>({user_id:a,whoop_sleep_id:b.id,start:new Date(b.start),end:new Date(b.end),timezone_offset:b.timezone_offset||null,sleep_performance_percentage:b.score?.sleep_performance_percentage||null,total_sleep_time_milli:b.score?.stage_summary?.total_in_bed_time_milli||null,sleep_efficiency_percentage:b.score?.sleep_efficiency_percentage||null,slow_wave_sleep_time_milli:b.score?.stage_summary?.total_slow_wave_sleep_time_milli||null,rem_sleep_time_milli:b.score?.stage_summary?.total_rem_sleep_time_milli||null,light_sleep_time_milli:b.score?.stage_summary?.total_light_sleep_time_milli||null,wake_time_milli:b.score?.stage_summary?.total_awake_time_milli||null,arousal_time_milli:b.score?.stage_summary?.total_awake_time_milli||null,disturbance_count:b.score?.stage_summary?.disturbance_count||null,sleep_latency_milli:null,raw_data:JSON.stringify(b)}))).onConflictDoNothing(),h.length}catch(a){throw console.error("Error syncing sleep:",a),a}}async function I(a,b){try{let c=await fetch("https://api.prod.whoop.com/developer/v2/user/profile/basic",{headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"}});if(!c.ok){let a=Error(`WHOOP Profile API error: ${c.status}`);throw a.status=c.status,a}let d=await c.json();if((await w.db.select({id:x.whoopProfile.id}).from(x.whoopProfile).where((0,y.eq)(x.whoopProfile.user_id,a)).limit(1)).length>0)return await w.db.update(x.whoopProfile).set({email:d.email,first_name:d.first_name,last_name:d.last_name,raw_data:JSON.stringify(d),last_updated:new Date,updatedAt:new Date}).where((0,y.eq)(x.whoopProfile.user_id,a)),0;return await w.db.insert(x.whoopProfile).values({user_id:a,whoop_user_id:d.user_id.toString(),email:d.email,first_name:d.first_name,last_name:d.last_name,raw_data:JSON.stringify(d)}),1}catch(a){throw console.error("Error syncing profile:",a),a}}async function J(a,b){try{console.log(`[Body Measurements Sync] Starting sync for user ${a}`);let c=await fetch("https://api.prod.whoop.com/developer/v2/user/measurement/body",{headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"}});if(!c.ok){let a=await c.text();console.error(`[Body Measurements Sync] API error: ${c.status} - ${a}`);let b=Error(`WHOOP API v2 error for user/measurement/body: ${c.status} - ${a}`);throw b.status=c.status,b}let d=await c.json();if(console.log("[Body Measurements Sync] Fetched measurement data:",d),!d||!d.height_meter&&!d.weight_kilogram&&!d.max_heart_rate)return console.log("[Body Measurements Sync] No measurement data available"),0;let[e]=await w.db.select({id:x.whoopBodyMeasurement.id}).from(x.whoopBodyMeasurement).where((0,y.eq)(x.whoopBodyMeasurement.user_id,a)).limit(1),f=new Date().toISOString().split("T")[0],g={user_id:a,whoop_measurement_id:`${a}-${f}`,height_meter:d.height_meter||null,weight_kilogram:d.weight_kilogram||null,max_heart_rate:d.max_heart_rate||null,measurement_date:f,raw_data:JSON.stringify(d)};if(e)return console.log(`[Body Measurements Sync] Updating existing measurement for user ${a}`),await w.db.update(x.whoopBodyMeasurement).set({height_meter:g.height_meter,weight_kilogram:g.weight_kilogram,max_heart_rate:g.max_heart_rate,measurement_date:new Date(g.measurement_date),raw_data:g.raw_data,updatedAt:new Date}).where((0,y.eq)(x.whoopBodyMeasurement.user_id,a)),0;return console.log(`[Body Measurements Sync] Inserting new measurement for user ${a}`),await w.db.insert(x.whoopBodyMeasurement).values({...g,measurement_date:new Date(g.measurement_date)}),1}catch(a){throw console.error("Error syncing body measurements:",a),a}}async function K(a){try{let b=await v.x.get(a);if(!b||v.x.isExpired(b))return u.NextResponse.json({error:"Unauthorized"},{status:401});let c=await (0,A.E)(b.userId,"whoop_sync_all",10,36e5);if(!c.allowed)return u.NextResponse.json({error:"Rate limit exceeded",resetTime:c.resetTime},{status:429});let[d]=await w.db.select().from(x.userIntegrations).where((0,y.Uo)((0,y.eq)(x.userIntegrations.user_id,b.userId),(0,y.eq)(x.userIntegrations.provider,"whoop"),(0,y.eq)(x.userIntegrations.isActive,!0))).limit(1);if(!d)return u.NextResponse.json({error:"No active WHOOP integration found"},{status:404});let e=await (0,B.uX)(b.userId,"whoop");if(!e.token)return u.NextResponse.json({error:"Token validation failed",details:e.error||"No valid token available",needsReauthorization:!0},{status:401});let f=e.token,g={workouts:0,recovery:0,cycles:0,sleep:0,profile:0,bodyMeasurements:0,errors:[]},h=!1;try{g.workouts=await E(b.userId,f)}catch(b){let a=String(b);(401===b.status||a.includes("401"))&&(h=!0),g.errors.push(`Workouts: ${a}`)}if(!h){try{g.recovery=await F(b.userId,f)}catch(b){let a=String(b);(401===b.status||a.includes("401"))&&(h=!0),g.errors.push(`Recovery: ${a}`)}try{g.cycles=await G(b.userId,f)}catch(b){let a=String(b);401===b.status||a.includes("401")?h=!0:403===b.status||a.includes("403")?console.log("Cycles sync skipped: insufficient scope"):g.errors.push(`Cycles: ${a}`)}try{g.sleep=await H(b.userId,f)}catch(b){let a=String(b);(401===b.status||a.includes("401"))&&(h=!0),g.errors.push(`Sleep: ${a}`)}try{g.profile=await I(b.userId,f)}catch(b){let a=String(b);401===b.status||a.includes("401")?h=!0:403===b.status||a.includes("403")?console.log("Profile sync skipped: insufficient scope"):g.errors.push(`Profile: ${a}`)}try{g.bodyMeasurements=await J(b.userId,f)}catch(b){let a=String(b);401===b.status||a.includes("401")?h=!0:403===b.status||a.includes("403")?console.log("Body measurements sync skipped: insufficient scope"):g.errors.push(`Body Measurements: ${a}`)}}let i=g.workouts+g.recovery+g.cycles+g.sleep+g.profile+g.bodyMeasurements;if(h)return await w.db.update(x.userIntegrations).set({isActive:!1,updatedAt:new Date}).where((0,y.eq)(x.userIntegrations.id,d.id)),u.NextResponse.json({success:!1,synced:g,totalNewRecords:i,error:"WHOOP access token is invalid or expired. Please reconnect your WHOOP account.",needsReauthorization:!0},{status:401});return u.NextResponse.json({success:!0,synced:g,totalNewRecords:i,message:`Successfully synced ${i} new records across all data types`})}catch(a){return console.error("Comprehensive WHOOP sync error:",a),u.NextResponse.json({error:"Internal server error during sync"},{status:500})}}let L=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/whoop/sync-all/route",pathname:"/api/whoop/sync-all",filename:"route",bundlePath:"app/api/whoop/sync-all/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/steven/swole-tracker/src/app/api/whoop/sync-all/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:M,workUnitAsyncStorage:N,serverHooks:O}=L;function P(){return(0,g.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:N})}async function Q(a,b,c){var d;let e="/api/whoop/sync-all/route";"/index"===e&&(e="/");let g=await L.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||L.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===L.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>L.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>L.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await L.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await L.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(K||b instanceof s.NoFallbackError||await L.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},96487:()=>{}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[5873,1428,3708,7639,1692,1553],()=>b(b.s=92959));module.exports=c})();