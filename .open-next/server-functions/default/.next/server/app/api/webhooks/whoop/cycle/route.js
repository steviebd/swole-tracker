(()=>{var a={};a.id=9759,a.ids=[9759],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41429:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{GET:()=>E,POST:()=>D,runtime:()=>A});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(43723),w=c(87652),x=c(31553),y=c(30314),z=c(48689);let A="nodejs";async function B(a,b){try{if(12345===b)return console.log(`🧪 Test mode detected for cycle ${a} - creating mock cycle data`),{id:a,start:new Date(Date.now()-864e5).toISOString(),end:new Date().toISOString(),timezone_offset:"-08:00",score:{strain:12.5,average_heart_rate:72,max_heart_rate:185,kilojoule:2450.8}};let c=await (0,w.uX)(b.toString(),"whoop");if(!c.token)return console.error(`No valid Whoop token found for user ${b}: ${c.error}`),null;let d=await fetch(`https://api.prod.whoop.com/developer/v1/cycle/${a}`,{headers:{Authorization:`Bearer ${c.token}`,"Content-Type":"application/json"}});if(!d.ok)return console.error(`Failed to fetch cycle ${a} from Whoop API:`,d.status,await d.text()),null;let e=await d.json();if("object"!=typeof e||null===e)return console.error("Invalid cycle JSON for",a),null;if("string"==typeof e.id)return e;return console.error("Cycle data failed runtime validation in fetch",e),null}catch(b){return console.error(`Error fetching cycle ${a} from Whoop API:`,b),null}}async function C(a){console.log("Processing cycle update webhook:",a);try{let b=a.user_id.toString(),c=a.id.toString(),d=12345===a.user_id,e=d?"TEST_USER_12345":b,f=await B(c,a.user_id);if(!f)return void console.error(`Could not fetch cycle data for ${c}`);let[g]=await x.db.select().from(y.whoopCycles).where((0,z.eq)(y.whoopCycles.whoop_cycle_id,c));g?(console.log(`Updating existing cycle ${c} for user ${e}${d?" (TEST MODE)":""}`),await x.db.update(y.whoopCycles).set({start:f.start?new Date(f.start):new Date,end:f.end?new Date(f.end):new Date,timezone_offset:f.timezone_offset||null,day_strain:f.score?.strain||null,average_heart_rate:f.score?.average_heart_rate||null,max_heart_rate:f.score?.max_heart_rate||null,kilojoule:f.score?.kilojoule||null,raw_data:JSON.stringify(f),updatedAt:new Date}).where((0,z.eq)(y.whoopCycles.whoop_cycle_id,c))):(console.log(`Inserting new cycle ${c} for user ${e}${d?" (TEST MODE)":""}`),await x.db.insert(y.whoopCycles).values({user_id:e,whoop_cycle_id:c,start:f.start?new Date(f.start):new Date,end:f.end?new Date(f.end):new Date,timezone_offset:f.timezone_offset||null,day_strain:f.score?.strain||null,average_heart_rate:f.score?.average_heart_rate||null,max_heart_rate:f.score?.max_heart_rate||null,kilojoule:f.score?.kilojoule||null,raw_data:JSON.stringify(f)})),console.log(`Successfully processed cycle update for ${c}`)}catch(a){throw console.error("Error processing cycle update:",a),a}}async function D(a){let b=Date.now(),c=null;try{let d,e=(0,v.z)(a.headers);if(!e)return console.error("Invalid webhook headers received"),u.NextResponse.json({error:"Invalid webhook headers"},{status:400});let f=await a.text();if(!await (0,v.E)(f,e.signature,e.timestamp))return console.error("Invalid webhook signature"),u.NextResponse.json({error:"Invalid signature"},{status:401});try{d=JSON.parse(f)}catch(a){return console.error("Invalid JSON payload:",a),u.NextResponse.json({error:"Invalid JSON payload"},{status:400})}console.log(`🎣 Received Whoop cycle webhook:`,{type:d.type,userId:d.user_id,entityId:d.id,traceId:d.trace_id,timestamp:new Date().toISOString()});try{let[b]=await x.db.insert(y.webhookEvents).values({provider:"whoop",eventType:d.type,externalUserId:d.user_id.toString(),externalEntityId:d.id.toString(),payload:JSON.stringify(d),headers:JSON.stringify({signature:e.signature,timestamp:e.timestamp,userAgent:a.headers.get("user-agent")??void 0,contentType:a.headers.get("content-type")??void 0}),status:"received"}).returning({id:y.webhookEvents.id});c=b?.id??null,console.log(`📝 Logged webhook event with ID: ${c}`)}catch(a){console.error("Failed to log webhook event to database:",a)}if("cycle.updated"===d.type)return await C(d),c&&await x.db.update(y.webhookEvents).set({status:"processed",processingTime:Date.now()-b,processedAt:new Date}).where((0,z.eq)(y.webhookEvents.id,c)),console.log(`✅ Successfully processed cycle.updated webhook for user ${d.user_id}`),u.NextResponse.json({success:!0,message:"Cycle updated successfully"});return c&&await x.db.update(y.webhookEvents).set({status:"ignored",processingTime:Date.now()-b,processedAt:new Date}).where((0,z.eq)(y.webhookEvents.id,c)),console.log(`⏭️ Ignoring webhook event type: ${d.type}`),u.NextResponse.json({success:!0,message:"Event type not processed"})}catch(a){if(console.error("❌ Cycle webhook processing error:",a),c)try{await x.db.update(y.webhookEvents).set({status:"failed",error:a instanceof Error?a.message:String(a),processingTime:Date.now()-b,processedAt:new Date}).where((0,z.eq)(y.webhookEvents.id,c))}catch(a){console.error("Failed to update webhook event status:",a)}return u.NextResponse.json({error:"Internal server error"},{status:500})}}async function E(){return u.NextResponse.json({message:"Whoop cycle webhook endpoint is active",timestamp:new Date().toISOString()})}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/webhooks/whoop/cycle/route",pathname:"/api/webhooks/whoop/cycle",filename:"route",bundlePath:"app/api/webhooks/whoop/cycle/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/steven/swole-tracker/src/app/api/webhooks/whoop/cycle/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/webhooks/whoop/cycle/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},43723:(a,b,c)=>{"use strict";c.d(b,{E:()=>f,z:()=>g});var d=c(8579),e=c(72626);async function f(a,b,c){if(!d._.WHOOP_WEBHOOK_SECRET)return e.vF.error("WHOOP_WEBHOOK_SECRET not configured"),!1;try{let e=new TextEncoder,f=await crypto.subtle.importKey("raw",e.encode(d._.WHOOP_WEBHOOK_SECRET),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),g=await crypto.subtle.sign("HMAC",f,e.encode(c+a)),h=btoa(String.fromCharCode(...new Uint8Array(g)));return b===h}catch(a){return e.vF.error("Error verifying webhook signature",a),!1}}function g(a){let b=a.get("X-WHOOP-Signature"),c=a.get("X-WHOOP-Signature-Timestamp");if(!b||!c)return e.vF.warn("Missing required webhook headers"),null;let d=parseInt(c,10),f=Date.now(),g=f-3e5;return d<g||d>f?(e.vF.warn("Webhook timestamp outside acceptable range",{timestamp:c,now:f,fiveMinutesAgo:g}),null):{signature:b,timestamp:c}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50919:(a,b,c)=>{"use strict";c.d(b,{g_:()=>i,rE:()=>g});let d="AES-GCM";async function e(a,b){let c=new TextEncoder,e=await crypto.subtle.importKey("raw",c.encode(a),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:b.buffer,iterations:1e5,hash:"SHA-256"},e,{name:d,length:256},!1,["encrypt","decrypt"])}function f(){let a=process.env.ENCRYPTION_MASTER_KEY;if(!a)throw Error("ENCRYPTION_MASTER_KEY environment variable is required for token encryption");if(a.length<32)throw Error("ENCRYPTION_MASTER_KEY must be at least 32 characters long");return a}async function g(a){try{let b=f(),c=crypto.getRandomValues(new Uint8Array(32)),g=crypto.getRandomValues(new Uint8Array(16)),h=await e(b,c),i=new TextEncoder().encode(a),j=await crypto.subtle.encrypt({name:d,iv:g},h,i),k=j.slice(0,-16),l=j.slice(-16),m=new Uint8Array([...c,...g,...new Uint8Array(l),...new Uint8Array(k)]);return btoa(String.fromCharCode(...m))}catch(a){if(console.error("Token encryption failed:",a),a instanceof Error)throw a;throw Error("Failed to encrypt token")}}async function h(a){try{let b=f(),c=new Uint8Array(atob(a).split("").map(a=>a.charCodeAt(0))),g=c.subarray(0,32),h=c.subarray(32,48),i=c.subarray(48,64),j=c.subarray(64),k=await e(b,g),l=new Uint8Array([...j,...i]),m=await crypto.subtle.decrypt({name:d,iv:h},k,l);return new TextDecoder().decode(m)}catch(a){if(console.error("Token decryption failed:",a),a instanceof Error)throw a;throw Error("Failed to decrypt token")}}async function i(a){return!function(a){try{return Buffer.from(a,"base64").length>=65}catch{return!1}}(a)?a:h(a)}},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87652:(a,b,c)=>{"use strict";c.d(b,{uX:()=>l});var d=c(31553),e=c(30314),f=c(48689),g=c(8579),h=c(50919);async function i(a,b){try{let[c]=await d.db.select().from(e.userIntegrations).where((0,f.Uo)((0,f.eq)(e.userIntegrations.user_id,a),(0,f.eq)(e.userIntegrations.provider,b),(0,f.eq)(e.userIntegrations.isActive,!0)));if(!c)return{success:!1,error:"Integration not found"};if(!c.refreshToken)return{success:!1,error:"No refresh token available"};if(!function(a,b,c=!1){if(c)return!0;let d=new Date;return!!(a&&a.getTime()-d.getTime()<864e5||b&&d.getTime()-b.getTime()>6048e5)}(c.expiresAt||null,c.updatedAt||null))return{success:!0,newAccessToken:await (0,h.g_)(c.accessToken)};let g=await (0,h.g_)(c.refreshToken),i=await j(b,g);if(!i.success||!i.accessToken)return{success:!1,error:i.error};let k=await (0,h.rE)(i.accessToken),l=i.refreshToken?await (0,h.rE)(i.refreshToken):c.refreshToken,m=i.expiresIn?new Date(Date.now()+1e3*i.expiresIn):c.expiresAt;return await d.db.update(e.userIntegrations).set({accessToken:k,refreshToken:l,expiresAt:m,updatedAt:new Date}).where((0,f.eq)(e.userIntegrations.id,c.id)),{success:!0,newAccessToken:i.accessToken}}catch(c){return console.error("Token rotation failed:",{userId:a.substring(0,8)+"...",provider:b,error:c instanceof Error?c.message:"Unknown error"}),{success:!1,error:c instanceof Error?c.message:"Token rotation failed"}}}async function j(a,b){return"whoop"===a.toLowerCase()?await k(b):{success:!1,error:`Unsupported provider: ${a}`}}async function k(a){try{if(!g._.WHOOP_CLIENT_ID||!g._.WHOOP_CLIENT_SECRET)return{success:!1,error:"WHOOP credentials not configured"};let b={grant_type:"refresh_token",refresh_token:a,client_id:g._.WHOOP_CLIENT_ID,client_secret:g._.WHOOP_CLIENT_SECRET},c=await fetch("https://api.prod.whoop.com/oauth/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams(b).toString()});if(!c.ok)return{success:!1,error:`WHOOP token refresh failed: ${c.status} - ${c.statusText}`};let d=await c.json();if(!d.access_token)return{success:!1,error:"No access token in response"};return{success:!0,accessToken:d.access_token,refreshToken:d.refresh_token,expiresIn:d.expires_in}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Token refresh failed"}}}async function l(a,b){try{let c=await i(a,b);if(c.success&&c.newAccessToken)return{token:c.newAccessToken};return{token:null,error:c.error}}catch(a){return{token:null,error:a instanceof Error?a.message:"Failed to get valid token"}}}},96487:()=>{}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[5873,1428,3708,7639,1692,1553],()=>b(b.s=41429));module.exports=c})();