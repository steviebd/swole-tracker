"use strict";exports.id=1553,exports.ids=[1553],exports.modules={8579:(a,b,c)=>{c.d(b,{_:()=>g});var d=c(48948),e=c(59256),f=c(26961);let g=(0,d.w)({server:{CLOUDFLARE_ACCOUNT_ID:e.Yj().optional(),CLOUDFLARE_API_TOKEN:e.Yj().optional(),DB:e.bz().optional(),WORKOS_API_KEY:e.Yj().optional(),WORKOS_CLIENT_ID:e.Yj().optional(),WORKOS_REDIRECT_URI:e.Yj().url().optional(),WORKER_SESSION_SECRET:e.Yj().min(32).optional(),DATABASE_URL:e.Yj().url().optional(),NODE_ENV:e.k5(["development","test","production"]).default("development"),VERCEL_AI_GATEWAY_API_KEY:e.Yj().optional(),AI_GATEWAY_API_KEY:e.Yj().optional(),AI_GATEWAY_MODEL:e.Yj().default("xai/grok-3-mini"),AI_GATEWAY_PROMPT:e.Yj().default("Tell me a short, funny programming or tech joke. Keep it clean and under 100 words."),AI_GATEWAY_JOKE_MEMORY_NUMBER:f.ai().default(3),AI_GATEWAY_MODEL_HEALTH:e.Yj().default("xai/grok-3-mini"),AI_DEBRIEF_MODEL:e.Yj().default("xai/grok-3-mini"),AI_DEBRIEF_TEMPERATURE:f.ai().min(0).max(2).default(.7),WHOOP_CLIENT_ID:e.Yj().optional(),WHOOP_CLIENT_SECRET:e.Yj().optional(),WHOOP_REDIRECT_URI:e.Yj().url().optional(),WHOOP_SYNC_RATE_LIMIT_PER_HOUR:f.ai().default(10),WHOOP_WEBHOOK_SECRET:e.Yj().optional(),RATE_LIMIT_TEMPLATE_OPERATIONS_PER_HOUR:f.ai().default(100),RATE_LIMIT_WORKOUT_OPERATIONS_PER_HOUR:f.ai().default(200),RATE_LIMIT_API_CALLS_PER_MINUTE:f.ai().default(60),RATE_LIMIT_ENABLED:f.zM().default(!0),ENCRYPTION_MASTER_KEY:e.Yj().min(32).optional()},client:{NEXT_PUBLIC_SITE_URL:e.Yj().url().default("http://localhost:3000"),NEXT_PUBLIC_POSTHOG_KEY:e.Yj().default("phc_test_dummy"),NEXT_PUBLIC_POSTHOG_HOST:e.Yj().url().default("https://us.i.posthog.com")},runtimeEnv:{CLOUDFLARE_ACCOUNT_ID:process.env.CLOUDFLARE_ACCOUNT_ID,CLOUDFLARE_API_TOKEN:process.env.CLOUDFLARE_API_TOKEN,DB:process.env.DB,WORKOS_API_KEY:process.env.WORKOS_API_KEY,WORKOS_CLIENT_ID:process.env.WORKOS_CLIENT_ID,WORKOS_REDIRECT_URI:process.env.WORKOS_REDIRECT_URI,WORKER_SESSION_SECRET:process.env.WORKER_SESSION_SECRET,NEXT_PUBLIC_SITE_URL:"http://localhost:8787",NEXT_PUBLIC_POSTHOG_KEY:"phc_22bpojwvy9Gh9xx6cfDD0utukztzX6mbpkmQAN4tzQ2",NEXT_PUBLIC_POSTHOG_HOST:"https://us.i.posthog.com",DATABASE_URL:process.env.DATABASE_URL,NODE_ENV:"production",VERCEL_AI_GATEWAY_API_KEY:process.env.VERCEL_AI_GATEWAY_API_KEY,AI_GATEWAY_API_KEY:process.env.AI_GATEWAY_API_KEY,AI_GATEWAY_MODEL:process.env.AI_GATEWAY_MODEL,AI_GATEWAY_PROMPT:process.env.AI_GATEWAY_PROMPT,AI_GATEWAY_JOKE_MEMORY_NUMBER:process.env.AI_GATEWAY_JOKE_MEMORY_NUMBER,AI_GATEWAY_MODEL_HEALTH:process.env.AI_GATEWAY_MODEL_HEALTH,AI_DEBRIEF_MODEL:process.env.AI_DEBRIEF_MODEL,AI_DEBRIEF_TEMPERATURE:process.env.AI_DEBRIEF_TEMPERATURE,WHOOP_CLIENT_ID:process.env.WHOOP_CLIENT_ID,WHOOP_CLIENT_SECRET:process.env.WHOOP_CLIENT_SECRET,WHOOP_REDIRECT_URI:process.env.WHOOP_REDIRECT_URI,WHOOP_SYNC_RATE_LIMIT_PER_HOUR:process.env.WHOOP_SYNC_RATE_LIMIT_PER_HOUR,WHOOP_WEBHOOK_SECRET:process.env.WHOOP_WEBHOOK_SECRET,RATE_LIMIT_TEMPLATE_OPERATIONS_PER_HOUR:process.env.RATE_LIMIT_TEMPLATE_OPERATIONS_PER_HOUR,RATE_LIMIT_WORKOUT_OPERATIONS_PER_HOUR:process.env.RATE_LIMIT_WORKOUT_OPERATIONS_PER_HOUR,RATE_LIMIT_API_CALLS_PER_MINUTE:process.env.RATE_LIMIT_API_CALLS_PER_MINUTE,RATE_LIMIT_ENABLED:process.env.RATE_LIMIT_ENABLED,ENCRYPTION_MASTER_KEY:process.env.ENCRYPTION_MASTER_KEY},skipValidation:"preview"===process.env.VERCEL_ENV,emptyStringAsUndefined:!0})},30314:(a,b,c)=>{c.r(b),c.d(b,{aiSuggestionHistory:()=>J,aiSuggestionHistoryRelations:()=>V,createTable:()=>m,dailyJokes:()=>t,exerciseLinks:()=>y,exerciseLinksRelations:()=>R,externalWorkoutsWhoop:()=>v,externalWorkoutsWhoopRelations:()=>P,healthAdvice:()=>z,healthAdviceRelations:()=>S,masterExercises:()=>x,masterExercisesRelations:()=>Q,oauthStates:()=>I,rateLimits:()=>w,sessionDebriefs:()=>A,sessionDebriefsRelations:()=>T,sessionExercises:()=>r,sessionExercisesRelations:()=>N,templateExercises:()=>q,templateExercisesRelations:()=>L,userIntegrations:()=>u,userIntegrationsRelations:()=>O,userPreferences:()=>s,users:()=>n,webhookEvents:()=>B,wellnessData:()=>C,wellnessDataRelations:()=>U,whoopBodyMeasurement:()=>H,whoopBodyMeasurementRelations:()=>$,whoopCycles:()=>E,whoopCyclesRelations:()=>X,whoopProfile:()=>G,whoopProfileRelations:()=>Z,whoopRecovery:()=>D,whoopRecoveryRelations:()=>W,whoopSleep:()=>F,whoopSleepRelations:()=>Y,workoutSessions:()=>p,workoutSessionsRelations:()=>M,workoutTemplates:()=>o,workoutTemplatesRelations:()=>K});var d=c(85766),e=c(30248),f=c(57004),g=c(82543),h=c(58040),i=c(4035),j=c(20377),k=c(19643);let l=(0,f._z)({dataType:()=>"text",toDriver:a=>a.toISOString(),fromDriver:a=>new Date(a)}),m=g.D,n=m("user",{id:(0,h.Qq)().primaryKey(),email:(0,h.Qq)(),firstName:(0,h.Qq)(),lastName:(0,h.Qq)(),profilePictureUrl:(0,h.Qq)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("user_email_idx").on(a.email)]),o=m("workout_template",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),name:(0,h.Qq)().notNull(),user_id:(0,h.Qq)().notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("template_user_id_idx").on(a.user_id),(0,i.Pe)("template_name_idx").on(a.name)]),p=m("workout_session",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),templateId:(0,j.nd)().references(()=>o.id,{onDelete:"set null"}),workoutDate:l().default((0,d.ll)`(datetime('now'))`).notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("workout_session_user_id_idx").on(a.user_id),(0,i.Pe)("workout_session_template_id_idx").on(a.templateId),(0,i.Pe)("workout_session_workout_date_idx").on(a.workoutDate),(0,i.Pe)("workout_session_user_date_idx").on(a.user_id,a.workoutDate)]),q=m("template_exercise",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),templateId:(0,j.nd)().notNull().references(()=>o.id,{onDelete:"cascade"}),exerciseName:(0,h.Qq)().notNull(),orderIndex:(0,j.nd)().notNull().default(0),linkingRejected:(0,j.nd)({mode:"boolean"}).notNull().default(!1),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("template_exercise_user_id_idx").on(a.user_id),(0,i.Pe)("template_exercise_template_id_idx").on(a.templateId),(0,i.Pe)("template_exercise_order_idx").on(a.templateId,a.orderIndex)]),r=m("session_exercise",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),sessionId:(0,j.nd)().notNull().references(()=>p.id,{onDelete:"cascade"}),templateExerciseId:(0,j.nd)().references(()=>q.id,{onDelete:"set null"}),exerciseName:(0,h.Qq)().notNull(),setOrder:(0,j.nd)().notNull().default(0),weight:(0,k.x)(),reps:(0,j.nd)(),sets:(0,j.nd)(),unit:(0,h.Qq)().notNull().default("kg"),rpe:(0,j.nd)(),rest_seconds:(0,j.nd)(),is_estimate:(0,j.nd)({mode:"boolean"}).notNull().default(!1),is_default_applied:(0,j.nd)({mode:"boolean"}).notNull().default(!1),one_rm_estimate:(0,k.x)(),volume_load:(0,k.x)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("session_exercise_user_id_idx").on(a.user_id),(0,i.Pe)("session_exercise_session_id_idx").on(a.sessionId),(0,i.Pe)("session_exercise_template_exercise_id_idx").on(a.templateExerciseId),(0,i.Pe)("session_exercise_name_idx").on(a.exerciseName),(0,i.Pe)("session_exercise_user_exercise_idx").on(a.user_id,a.exerciseName),(0,i.Pe)("session_exercise_user_exercise_date_idx").on(a.user_id,a.exerciseName,a.sessionId),(0,i.Pe)("session_exercise_user_template_idx").on(a.user_id,a.templateExerciseId),(0,i.Pe)("session_exercise_user_weight_idx").on(a.user_id,a.weight),(0,i.Pe)("session_exercise_user_exercise_weight_idx").on(a.user_id,a.exerciseName,a.weight),(0,i.Pe)("session_exercise_user_one_rm_idx").on(a.user_id,a.one_rm_estimate),(0,i.Pe)("session_exercise_user_volume_idx").on(a.user_id,a.volume_load),(0,i.Pe)("session_exercise_user_exercise_one_rm_idx").on(a.user_id,a.exerciseName,a.one_rm_estimate),(0,i.Pe)("session_exercise_user_exercise_volume_idx").on(a.user_id,a.exerciseName,a.volume_load)]),s=m("user_preferences",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull().unique(),defaultWeightUnit:(0,h.Qq)().notNull().default("kg"),predictive_defaults_enabled:(0,j.nd)({mode:"boolean"}).notNull().default(!1),right_swipe_action:(0,h.Qq)().notNull().default("collapse_expand"),enable_manual_wellness:(0,j.nd)({mode:"boolean"}).notNull().default(!1),progression_type:(0,h.Qq)().notNull().default("adaptive"),linear_progression_kg:(0,k.x)().default(2.5),percentage_progression:(0,k.x)().default(2.5),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("user_preferences_user_id_idx").on(a.user_id)]),t=m("daily_joke",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),joke:(0,h.Qq)().notNull(),aiModel:(0,h.Qq)().notNull(),prompt:(0,h.Qq)().notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("daily_joke_user_id_idx").on(a.user_id),(0,i.Pe)("daily_joke_created_at_idx").on(a.createdAt),(0,i.Pe)("daily_joke_user_date_idx").on(a.user_id,a.createdAt)]),u=m("user_integration",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),provider:(0,h.Qq)().notNull(),accessToken:(0,h.Qq)().notNull(),refreshToken:(0,h.Qq)(),expiresAt:l(),scope:(0,h.Qq)(),isActive:(0,j.nd)({mode:"boolean"}).notNull().default(!0),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("user_integration_user_id_idx").on(a.user_id),(0,i.Pe)("user_integration_provider_idx").on(a.provider),(0,i.Pe)("user_integration_user_provider_idx").on(a.user_id,a.provider)]),v=m("whoop_workout",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),whoopWorkoutId:(0,h.Qq)().notNull().unique(),start:l().notNull(),end:l().notNull(),timezone_offset:(0,h.Qq)(),sport_name:(0,h.Qq)(),score_state:(0,h.Qq)(),score:(0,h.Qq)(),during:(0,h.Qq)(),zone_duration:(0,h.Qq)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("external_workout_whoop_user_id_idx").on(a.user_id),(0,i.Pe)("external_workout_whoop_workout_id_idx").on(a.whoopWorkoutId),(0,i.Pe)("external_workout_whoop_start_idx").on(a.start),(0,i.Pe)("external_workout_whoop_user_start_idx").on(a.user_id,a.start),(0,i.Pe)("external_workout_whoop_user_workout_id_idx").on(a.user_id,a.whoopWorkoutId)]),w=m("rate_limit",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),endpoint:(0,h.Qq)().notNull(),requests:(0,j.nd)().notNull().default(0),windowStart:(0,h.Qq)().notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("rate_limit_user_endpoint_idx").on(a.user_id,a.endpoint),(0,i.Pe)("rate_limit_window_idx").on(a.windowStart)]),x=m("master_exercise",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),name:(0,h.Qq)().notNull(),normalizedName:(0,h.Qq)().notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("master_exercise_user_id_idx").on(a.user_id),(0,i.Pe)("master_exercise_name_idx").on(a.name),(0,i.Pe)("master_exercise_normalized_name_idx").on(a.normalizedName),(0,i.Pe)("master_exercise_user_normalized_idx").on(a.user_id,a.normalizedName)]),y=m("exercise_link",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),templateExerciseId:(0,j.nd)().notNull().references(()=>q.id,{onDelete:"cascade"}),masterExerciseId:(0,j.nd)().notNull().references(()=>x.id,{onDelete:"cascade"}),user_id:(0,h.Qq)().notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("exercise_link_template_exercise_idx").on(a.templateExerciseId),(0,i.Pe)("exercise_link_master_exercise_idx").on(a.masterExerciseId),(0,i.Pe)("exercise_link_user_id_idx").on(a.user_id)]),z=m("health_advice",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),sessionId:(0,j.nd)().notNull().references(()=>p.id,{onDelete:"cascade"}),request:(0,h.Qq)().notNull(),response:(0,h.Qq)().notNull(),readiness_rho:(0,k.x)(),overload_multiplier:(0,k.x)(),session_predicted_chance:(0,k.x)(),user_accepted_suggestions:(0,j.nd)().notNull().default(0),total_suggestions:(0,j.nd)().notNull(),response_time_ms:(0,j.nd)(),model_used:(0,h.Qq)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("health_advice_user_id_idx").on(a.user_id),(0,i.Pe)("health_advice_session_id_idx").on(a.sessionId),(0,i.Pe)("health_advice_created_at_idx").on(a.createdAt),(0,i.Pe)("health_advice_user_created_idx").on(a.user_id,a.createdAt)]),A=m("session_debrief",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),sessionId:(0,j.nd)().notNull().references(()=>p.id,{onDelete:"cascade"}),version:(0,j.nd)().notNull().default(1),parentDebriefId:(0,j.nd)(),summary:(0,h.Qq)().notNull(),prHighlights:(0,h.Qq)(),adherenceScore:(0,k.x)(),focusAreas:(0,h.Qq)(),streakContext:(0,h.Qq)(),overloadDigest:(0,h.Qq)(),metadata:(0,h.Qq)(),isActive:(0,j.nd)({mode:"boolean"}).notNull().default(!0),viewedAt:l(),dismissedAt:l(),pinnedAt:l(),regenerationCount:(0,j.nd)().notNull().default(0),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("session_debrief_user_idx").on(a.user_id),(0,i.Pe)("session_debrief_session_idx").on(a.sessionId),(0,i.Pe)("session_debrief_created_idx").on(a.createdAt),(0,i.Pe)("session_debrief_user_created_idx").on(a.user_id,a.createdAt)]),B=m("webhook_event",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),provider:(0,h.Qq)().notNull(),eventType:(0,h.Qq)().notNull(),userId:(0,h.Qq)(),externalUserId:(0,h.Qq)(),externalEntityId:(0,h.Qq)(),payload:(0,h.Qq)(),headers:(0,h.Qq)(),status:(0,h.Qq)().notNull().default("received"),error:(0,h.Qq)(),processingTime:(0,j.nd)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),processedAt:l()},a=>[(0,i.Pe)("webhook_event_provider_idx").on(a.provider),(0,i.Pe)("webhook_event_type_idx").on(a.eventType),(0,i.Pe)("webhook_event_user_id_idx").on(a.userId),(0,i.Pe)("webhook_event_external_user_id_idx").on(a.externalUserId),(0,i.Pe)("webhook_event_status_idx").on(a.status),(0,i.Pe)("webhook_event_created_at_idx").on(a.createdAt)]),C=m("wellness_data",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),sessionId:(0,j.nd)().references(()=>p.id,{onDelete:"cascade"}),date:l().notNull(),energy_level:(0,j.nd)(),sleep_quality:(0,j.nd)(),device_timezone:(0,h.Qq)(),submitted_at:l().default((0,d.ll)`(datetime('now'))`).notNull(),has_whoop_data:(0,j.nd)({mode:"boolean"}).notNull().default(!1),whoop_data:(0,h.Qq)(),notes:(0,h.Qq)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("wellness_data_user_id_idx").on(a.user_id),(0,i.Pe)("wellness_data_user_date_idx").on(a.user_id,a.date),(0,i.Pe)("wellness_data_user_session_idx").on(a.user_id,a.sessionId),(0,i.Pe)("wellness_data_submitted_at_idx").on(a.user_id,a.submitted_at)]),D=m("whoop_recovery",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),whoop_recovery_id:(0,h.Qq)().notNull().unique(),cycle_id:(0,h.Qq)(),date:l().notNull(),recovery_score:(0,j.nd)(),hrv_rmssd_milli:(0,k.x)(),hrv_rmssd_baseline:(0,k.x)(),resting_heart_rate:(0,j.nd)(),resting_heart_rate_baseline:(0,j.nd)(),raw_data:(0,h.Qq)(),timezone_offset:(0,h.Qq)(),webhook_received_at:l().default((0,d.ll)`(datetime('now'))`).notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("whoop_recovery_user_id_idx").on(a.user_id),(0,i.Pe)("whoop_recovery_user_date_idx").on(a.user_id,a.date),(0,i.Pe)("whoop_recovery_whoop_id_idx").on(a.whoop_recovery_id),(0,i.Pe)("whoop_recovery_cycle_id_idx").on(a.cycle_id),(0,i.Pe)("whoop_recovery_user_received_idx").on(a.user_id,a.webhook_received_at)]),E=m("whoop_cycle",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),whoop_cycle_id:(0,h.Qq)().notNull().unique(),start:l().notNull(),end:l().notNull(),timezone_offset:(0,h.Qq)(),day_strain:(0,k.x)(),average_heart_rate:(0,j.nd)(),max_heart_rate:(0,j.nd)(),kilojoule:(0,k.x)(),raw_data:(0,h.Qq)(),webhook_received_at:l().default((0,d.ll)`(datetime('now'))`).notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("whoop_cycle_user_id_idx").on(a.user_id),(0,i.Pe)("whoop_cycle_user_start_idx").on(a.user_id,a.start),(0,i.Pe)("whoop_cycle_whoop_id_idx").on(a.whoop_cycle_id),(0,i.Pe)("whoop_cycle_strain_idx").on(a.user_id,a.day_strain)]),F=m("whoop_sleep",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),whoop_sleep_id:(0,h.Qq)().notNull().unique(),start:l().notNull(),end:l().notNull(),timezone_offset:(0,h.Qq)(),sleep_performance_percentage:(0,j.nd)(),total_sleep_time_milli:(0,j.nd)(),sleep_efficiency_percentage:(0,k.x)(),slow_wave_sleep_time_milli:(0,j.nd)(),rem_sleep_time_milli:(0,j.nd)(),light_sleep_time_milli:(0,j.nd)(),wake_time_milli:(0,j.nd)(),arousal_time_milli:(0,j.nd)(),disturbance_count:(0,j.nd)(),sleep_latency_milli:(0,j.nd)(),raw_data:(0,h.Qq)(),webhook_received_at:l().default((0,d.ll)`(datetime('now'))`).notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("whoop_sleep_user_id_idx").on(a.user_id),(0,i.Pe)("whoop_sleep_user_start_idx").on(a.user_id,a.start),(0,i.Pe)("whoop_sleep_whoop_id_idx").on(a.whoop_sleep_id),(0,i.Pe)("whoop_sleep_performance_idx").on(a.user_id,a.sleep_performance_percentage)]),G=m("whoop_profile",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),whoop_user_id:(0,h.Qq)().notNull(),email:(0,h.Qq)(),first_name:(0,h.Qq)(),last_name:(0,h.Qq)(),raw_data:(0,h.Qq)(),webhook_received_at:l().default((0,d.ll)`(datetime('now'))`).notNull(),last_updated:l().default((0,d.ll)`(datetime('now'))`).notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("whoop_profile_user_id_idx").on(a.user_id),(0,i.Pe)("whoop_profile_whoop_user_id_idx").on(a.whoop_user_id)]),H=m("whoop_body_measurement",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),whoop_measurement_id:(0,h.Qq)().notNull().unique(),height_meter:(0,k.x)(),weight_kilogram:(0,k.x)(),max_heart_rate:(0,j.nd)(),measurement_date:l(),raw_data:(0,h.Qq)(),webhook_received_at:l().default((0,d.ll)`(datetime('now'))`).notNull(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull(),updatedAt:l()},a=>[(0,i.Pe)("whoop_body_measurement_user_id_idx").on(a.user_id),(0,i.Pe)("whoop_body_measurement_date_idx").on(a.user_id,a.measurement_date),(0,i.Pe)("whoop_body_measurement_whoop_id_idx").on(a.whoop_measurement_id)]),I=m("oauth_state",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),state:(0,h.Qq)().notNull().unique(),user_id:(0,h.Qq)().notNull(),provider:(0,h.Qq)().notNull(),redirect_uri:(0,h.Qq)().notNull(),client_ip:(0,h.Qq)(),user_agent_hash:(0,h.Qq)(),expiresAt:l().notNull().default((0,d.ll)`(datetime('now', '+10 minutes'))`),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("oauth_state_user_id_idx").on(a.user_id),(0,i.Pe)("oauth_state_provider_idx").on(a.provider),(0,i.Pe)("oauth_state_expires_at_idx").on(a.expiresAt),(0,i.Pe)("oauth_state_user_provider_idx").on(a.user_id,a.provider)]),J=m("ai_suggestion_history",{id:(0,j.nd)().primaryKey({autoIncrement:!0}),user_id:(0,h.Qq)().notNull(),sessionId:(0,j.nd)().notNull().references(()=>p.id,{onDelete:"cascade"}),exerciseName:(0,h.Qq)().notNull(),setId:(0,h.Qq)().notNull(),setIndex:(0,j.nd)().notNull(),suggested_weight_kg:(0,k.x)(),suggested_reps:(0,j.nd)(),suggested_rest_seconds:(0,j.nd)(),suggestion_rationale:(0,h.Qq)(),action:(0,h.Qq)().notNull(),accepted_weight_kg:(0,k.x)(),accepted_reps:(0,j.nd)(),progression_type:(0,h.Qq)(),readiness_score:(0,k.x)(),plateau_detected:(0,j.nd)({mode:"boolean"}).notNull().default(!1),interaction_time_ms:(0,j.nd)(),createdAt:l().default((0,d.ll)`(datetime('now'))`).notNull()},a=>[(0,i.Pe)("ai_suggestion_history_user_id_idx").on(a.user_id),(0,i.Pe)("ai_suggestion_history_session_idx").on(a.sessionId),(0,i.Pe)("ai_suggestion_history_exercise_idx").on(a.exerciseName),(0,i.Pe)("ai_suggestion_history_action_idx").on(a.action),(0,i.Pe)("ai_suggestion_history_created_at_idx").on(a.createdAt),(0,i.Pe)("ai_suggestion_history_user_created_idx").on(a.user_id,a.createdAt)]),K=(0,e.K1)(o,({many:a})=>({exercises:a(q),sessions:a(p)})),L=(0,e.K1)(q,({one:a,many:b})=>({template:a(o,{fields:[q.templateId],references:[o.id]}),sessionExercises:b(r),exerciseLink:a(y,{fields:[q.id],references:[y.templateExerciseId]})})),M=(0,e.K1)(p,({one:a,many:b})=>({template:a(o,{fields:[p.templateId],references:[o.id]}),exercises:b(r),healthAdvice:a(z,{fields:[p.id],references:[z.sessionId]}),wellnessData:a(C,{fields:[p.id],references:[C.sessionId]})})),N=(0,e.K1)(r,({one:a})=>({session:a(p,{fields:[r.sessionId],references:[p.id]}),templateExercise:a(q,{fields:[r.templateExerciseId],references:[q.id]})})),O=(0,e.K1)(u,({many:a})=>({whoopWorkouts:a(v)})),P=(0,e.K1)(v,({one:a})=>({integration:a(u,{fields:[v.user_id],references:[u.user_id]})})),Q=(0,e.K1)(x,({many:a})=>({exerciseLinks:a(y)})),R=(0,e.K1)(y,({one:a})=>({templateExercise:a(q,{fields:[y.templateExerciseId],references:[q.id]}),masterExercise:a(x,{fields:[y.masterExerciseId],references:[x.id]})})),S=(0,e.K1)(z,({one:a})=>({session:a(p,{fields:[z.sessionId],references:[p.id]})})),T=(0,e.K1)(A,({one:a,many:b})=>({session:a(p,{fields:[A.sessionId],references:[p.id]}),parent:a(A,{fields:[A.parentDebriefId],references:[A.id],relationName:"session_debrief_parent"}),versions:b(A,{relationName:"session_debrief_parent"})})),U=(0,e.K1)(C,({one:a})=>({session:a(p,{fields:[C.sessionId],references:[p.id]})})),V=(0,e.K1)(J,({one:a})=>({session:a(p,{fields:[J.sessionId],references:[p.id]})})),W=(0,e.K1)(D,({one:a})=>({cycle:a(E,{fields:[D.cycle_id],references:[E.whoop_cycle_id]})})),X=(0,e.K1)(E,({many:a})=>({recoveries:a(D)})),Y=(0,e.K1)(F,({})=>({})),Z=(0,e.K1)(G,({})=>({})),$=(0,e.K1)(H,({})=>({}))},31553:(a,b,c)=>{let d,e;c.d(b,{db:()=>l});var f=c(837),g=c(8579),h=c(30314),i=c(72626);class j{trackQuery(a,b,c,d){let e={query:this.sanitizeQuery(a),duration:b,timestamp:new Date,success:c,error:d};this.metrics.totalQueries++,c||(this.metrics.errors++,i.vF.warn("Database query error",{query:e.query,error:d})),b>this.slowQueryThreshold&&(this.metrics.slowQueries++,i.vF.warn("Slow database query detected",{query:e.query,duration:b,threshold:this.slowQueryThreshold})),this.metrics.averageQueryTime=0===this.metrics.averageQueryTime?b:.9*this.metrics.averageQueryTime+.1*b,this.queryHistory.push(e),this.queryHistory.length>this.maxHistorySize&&this.queryHistory.shift(),this.metrics.totalQueries%100==0&&this.logPerformanceMetrics()}updateConnectionMetrics(a){this.metrics.activeConnections=a.active,this.metrics.idleConnections=a.idle,this.metrics.totalConnections=a.total,this.metrics.waitingQueries=a.waiting,a.waiting>5&&i.vF.warn("High number of waiting queries",{waiting:a.waiting}),a.active/a.total>.8&&i.vF.warn("High connection pool utilization",{utilization:`${Math.round(a.active/a.total*100)}%`,active:a.active,total:a.total})}getMetrics(){return{...this.metrics,uptime:Date.now()-this.metrics.uptime}}getQueryHistory(a=50){return this.queryHistory.slice(-a)}getSlowQueries(a=20){return this.queryHistory.filter(a=>a.duration>this.slowQueryThreshold).slice(-a)}getErrorQueries(a=20){return this.queryHistory.filter(a=>!a.success).slice(-a)}resetMetrics(){this.metrics={activeConnections:this.metrics.activeConnections,idleConnections:this.metrics.idleConnections,totalConnections:this.metrics.totalConnections,waitingQueries:this.metrics.waitingQueries,totalQueries:0,averageQueryTime:0,slowQueries:0,errors:0,uptime:Date.now()},this.queryHistory=[]}sanitizeQuery(a){return a.replace(/VALUES\s*\([^)]+\)/gi,"VALUES (...)").replace(/=\s*'[^']*'/gi,"= '[REDACTED]'").replace(/=\s*\$\d+/gi,"= $[PARAM]").substring(0,200)}logPerformanceMetrics(){let a=this.getMetrics(),b=this.getErrorQueries(10),c=this.getSlowQueries(10);i.vF.info("Database performance metrics",{totalQueries:a.totalQueries,averageQueryTime:Math.round(a.averageQueryTime),slowQueries:a.slowQueries,errors:a.errors,activeConnections:a.activeConnections,connectionUtilization:`${Math.round(a.activeConnections/a.totalConnections*100)}%`,uptime:Math.round(a.uptime/1e3/60)}),b.length>0&&i.vF.warn("Recent database errors",{count:b.length,errors:b.map(a=>({query:a.query,error:a.error}))}),c.length>0&&i.vF.warn("Recent slow queries",{count:c.length,queries:c.map(a=>({query:a.query,duration:a.duration}))})}constructor(){this.metrics={activeConnections:0,idleConnections:0,totalConnections:0,waitingQueries:0,totalQueries:0,averageQueryTime:0,slowQueries:0,errors:0,uptime:Date.now()},this.queryHistory=[],this.maxHistorySize=1e3,this.slowQueryThreshold=1e3}}new j;let k=Symbol.for("__cloudflare-context__"),l=new Proxy({},{get(a,b,c){let i=function(){let a=function(){let a=globalThis[k];return a?.env}(),b=a?.DB??g._.DB;if("object"!=typeof b||null===b||"function"!=typeof b.prepare)throw Error("Cloudflare D1 binding `DB` is not available. Ensure wrangler.toml binds the database and requests run through the Workers runtime.");return d&&b===e||(d=(0,f.f)(b,{schema:h}),e=b),d}(),j=Reflect.get(i,b,c);return"function"==typeof j?j.bind(i):j}})},72626:(a,b,c)=>{c.d(b,{H4:()=>f,h4:()=>g,vF:()=>e});class d{shouldLog(a){return!this.isTest&&(!!this.isDevelopment||"warn"===a||"error"===a)}sanitizeContext(a){let b={...a};return delete b.accessToken,delete b.refreshToken,delete b.password,delete b.secret,this.isDevelopment||Object.keys(b).forEach(a=>{let c=b[a];"string"==typeof c&&c.length>100&&(b[a]=c.substring(0,97)+"...")}),b}debug(a,b){this.shouldLog("debug")&&console.log(`[DEBUG] ${a}`,b?this.sanitizeContext(b):{})}info(a,b){this.shouldLog("info")&&console.log(`[INFO] ${a}`,b?this.sanitizeContext(b):{})}warn(a,b){this.shouldLog("warn")&&console.warn(`[WARN] ${a}`,b?this.sanitizeContext(b):{})}error(a,b,c){if(!this.shouldLog("error"))return;let d=c?this.sanitizeContext(c):{};b instanceof Error?console.error(`[ERROR] ${a}`,{error:b.message,stack:this.isDevelopment?b.stack:void 0,...d}):console.error(`[ERROR] ${a}`,{error:b,...d})}webhook(a,b,c){if(this.isDevelopment){let d={...c,payload:b};this.debug(`Webhook: ${a}`,d)}else this.info(`Webhook: ${a}`,c)}timing(a,b,c){this.isDevelopment&&this.debug(`${a} took ${b}ms`,c)}security(a,b){(console.warn??console.log)(`[SECURITY] ${a}`,b?this.sanitizeContext(b):{})}constructor(){this.isDevelopment=!1,this.isTest=!1}}let e=new d,f=(a,b,c)=>{void 0!==c?e.timing(a,c,{userId:b,endpoint:a}):e.debug(`API call: ${a}`,{userId:b,endpoint:a})},g=(a,b,c)=>{e.security(a,{userId:b,...c})}}};