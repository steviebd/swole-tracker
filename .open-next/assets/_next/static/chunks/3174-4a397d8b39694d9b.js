"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3174],{60080:(e,t,r)=>{r.d(t,{z:()=>l});var s=r(26614);let a=(e,t)=>{try{if("undefined"==typeof navigator||!0!==navigator.onLine)return;s.Ay.capture(e,null!=t?t:{})}catch(e){}},l={pageView:(e,t)=>{try{let r=window.location.href;a("$pageview",{$current_url:r,page:e,...t})}catch(e){}},workoutStarted:(e,t)=>{a("workout_started",{templateId:e,templateName:t,timestamp:new Date().toISOString()})},workoutCompleted:(e,t,r)=>{a("workout_completed",{sessionId:e,duration:t,exerciseCount:r,timestamp:new Date().toISOString()})},exerciseLogged:(e,t,r,s)=>{a("exercise_logged",{exerciseId:e,exerciseName:t,sets:r,weight:s,timestamp:new Date().toISOString()})},templateCreated:(e,t)=>{a("template_created",{templateId:e,exerciseCount:t,timestamp:new Date().toISOString()})},templateDeleted:e=>{a("template_deleted",{templateId:e,timestamp:new Date().toISOString()})},templateEdited:(e,t)=>{a("template_edited",{templateId:e,exerciseCount:t,timestamp:new Date().toISOString()})},templateDuplicated:e=>{a("template_duplicated",{templateId:e,timestamp:new Date().toISOString()})},weightUnitChanged:e=>{a("weight_unit_changed",{unit:e,timestamp:new Date().toISOString()})},error:(e,t)=>{a("error",{error:e.message,stack:e.stack,context:t,timestamp:new Date().toISOString()})},featureUsed:(e,t)=>{a("feature_used",{feature:e,...t,timestamp:new Date().toISOString()})},aiDebriefViewed:(e,t,r)=>{a("ai_debrief.viewed",{sessionId:e,version:t,streakLength:r,timestamp:new Date().toISOString()})},aiDebriefRegenerated:(e,t,r)=>{a("ai_debrief.regenerated",{sessionId:e,version:t,reason:r,timestamp:new Date().toISOString()})},aiDebriefDismissed:(e,t,r)=>{a("ai_debrief.dismissed",{sessionId:e,version:t,pinned:r,timestamp:new Date().toISOString()})}}},83174:(e,t,r)=>{r.d(t,{TemplateForm:()=>y});var s=r(95155),a=r(12115),l=r(20063),n=r(22544),o=r(66942),i=r(2651),c=r(80842),d=r(60080);function u(e){var t;let{open:r,onClose:l,templateExerciseId:n,currentName:o}=e,[i,d]=(0,a.useState)(o),[u,x]=(0,a.useState)(0),[p,g]=(0,a.useState)([]),[v,h]=(0,a.useState)(null),[b,f]=(0,a.useState)(!1),y=(0,a.useRef)(null),j=c.F.exercises.linkToMaster.useMutation({onSuccess:()=>{l()}}),N=c.F.exercises.createOrGetMaster.useMutation({onSuccess:e=>{let t=Number(e.id),r=Number(n);j.mutate({templateExerciseId:r,masterExerciseId:t})}}),w=Number.isFinite(u)?u:0,C=c.F.exercises.searchMaster.useQuery({q:i,limit:20,cursor:null!=w?w:0},{enabled:r&&i.trim().length>0,staleTime:1e4});(0,a.useEffect)(()=>{r&&(setTimeout(()=>{var e;return null==(e=y.current)?void 0:e.focus()},0),d(o),x(0),g([]),h(null))},[r,o]),(0,a.useEffect)(()=>{if(!r)return;f(!0);let e=setTimeout(()=>{x(0),C.refetch().then(()=>f(!1))},250);return()=>clearTimeout(e)},[i]),(0,a.useEffect)(()=>{if(!C.data)return;let e=C.data.items,t=0===u?e:[...p,...e.filter(e=>!p.some(t=>t.id===e.id))];g(t);let r=m(i),s=t.find(e=>m(e.name)===r);h(null!=s?s:null)},[C.data]);let k=(0,a.useMemo)(()=>{var e;return"number"==typeof(null==(e=C.data)?void 0:e.nextCursor)},[null==(t=C.data)?void 0:t.nextCursor]);function S(e){j.mutate({templateExerciseId:n,masterExerciseId:e})}return r?(0,s.jsx)("div",{className:"fixed inset-0 z-40 flex items-center justify-center bg-black/40 p-4",onKeyDown:function(e){"Escape"===e.key&&l()},children:(0,s.jsxs)("div",{className:"border-border bg-background w-full max-w-lg rounded-lg border shadow-xl",children:[(0,s.jsxs)("div",{className:"border-border flex items-center justify-between border-b p-3",children:[(0,s.jsx)("div",{className:"text-foreground text-sm font-medium",children:"Link exercise"}),(0,s.jsx)("button",{onClick:l,className:"text-secondary hover:bg-muted rounded px-2 py-1 text-sm",children:"Close"})]}),(0,s.jsxs)("div",{className:"p-3",children:[(0,s.jsx)("input",{ref:y,value:i,onChange:e=>d(e.target.value),placeholder:"Search master exercises",className:"border-border bg-background placeholder:text-muted-foreground w-full rounded-md border px-3 py-2 text-sm outline-none focus:border-[color:var(--color-primary)]"}),v&&(0,s.jsxs)("div",{className:"mt-2 rounded border border-[var(--color-success)] bg-[var(--color-success-muted)] p-2 text-xs text-[var(--color-success)]",children:["Exact match found: “",v.name,"”",(0,s.jsx)("button",{onClick:()=>S(v.id),className:"ml-2 rounded bg-[var(--color-success)] px-2 py-1 text-xs text-white hover:bg-[var(--color-success)]/80",children:"Link to exact"})]}),(0,s.jsx)("div",{className:"border-border mt-3 max-h-72 overflow-y-auto rounded border",children:b&&0===p.length?(0,s.jsx)("div",{className:"p-3 text-sm text-gray-400",children:"Searching…"}):0===p.length?(0,s.jsx)("div",{className:"p-3 text-sm text-gray-400",children:"No results"}):(0,s.jsx)("ul",{children:p.map(e=>(0,s.jsxs)("li",{className:"border-border flex items-center justify-between border-b p-3 last:border-b-0",children:[(0,s.jsx)("span",{className:"text-foreground text-sm",children:e.name}),(0,s.jsx)("button",{onClick:()=>S(e.id),className:"text-background rounded bg-blue-600 px-2 py-1 text-xs hover:bg-blue-700 disabled:opacity-50",disabled:j.isPending,children:j.isPending?"Linking…":"Link"})]},e.id))})}),k&&(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)("button",{onClick:function(){var e,t;if(!k)return;let r=null!=(t=null==(e=C.data)?void 0:e.nextCursor)?t:0,s=Number.isFinite(r)?r:0;x(s),0!==s&&C.refetch()},className:"border-border text-foreground hover:bg-muted w-full rounded border px-3 py-2 text-sm",children:"Load more"})}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsx)("div",{className:"text-muted-foreground text-xs",children:"Can't find it? Create a new master exercise and link."}),(0,s.jsx)("button",{onClick:function(){N.mutate({name:i.trim()})},className:"btn-secondary px-3 py-1 text-xs disabled:opacity-50",disabled:N.isPending||0===i.trim().length,children:N.isPending?"Creating…":"Create “".concat(i.trim(),"”")})]})]})]})}):null}function m(e){return e.toLowerCase().trim().replace(/\s+/g," ")}function x(e){let{value:t,onChange:r,placeholder:l,className:n,style:o,templateExerciseId:i}=e,[d,m]=(0,a.useState)(!1),[x,g]=(0,a.useState)(!1),{data:v}=c.F.exercises.isLinkingRejected.useQuery({templateExerciseId:i},{enabled:!!i});(0,a.useEffect)(()=>{"boolean"==typeof v&&v!==x&&g(v)},[v]);let h=c.F.exercises.rejectLinking.useMutation({onSuccess:()=>{g(!0)}});return(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"text",value:t,onChange:e=>r(e.target.value),placeholder:l,className:n,style:o}),!x&&(0,s.jsx)("button",{type:"button",onClick:()=>m(!0),className:"shrink-0 rounded px-2 py-1 text-xs transition-colors",style:{backgroundColor:"var(--color-primary)",border:"1px solid var(--color-primary)",color:"var(--btn-primary-fg)"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--color-primary-hover)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="var(--color-primary)"},title:"Link to existing exercise",children:"Link"})]}),x&&(0,s.jsxs)("div",{className:"mt-1 flex items-center gap-2 text-xs",style:{color:"var(--color-warning)"},children:[(0,s.jsx)("span",{children:"\uD83D\uDD17"}),(0,s.jsx)("span",{children:"Not linked - will create as new exercise"})]}),!x&&(0,s.jsx)("div",{className:"mt-1",children:(0,s.jsx)("button",{type:"button",onClick:()=>{i?h.mutate({templateExerciseId:i}):g(!0)},disabled:h.isPending,className:"text-xs transition-colors",style:{color:"var(--color-text-muted)"},onMouseEnter:e=>{e.currentTarget.style.color="var(--color-text-secondary)"},onMouseLeave:e=>{e.currentTarget.style.color="var(--color-text-muted)"},children:h.isPending?"Saving...":"Don’t link this exercise"})}),d&&(null!=i?(0,s.jsx)(u,{open:d,onClose:()=>m(!1),templateExerciseId:i,currentName:t}):(0,s.jsx)(p,{open:d,onClose:()=>m(!1),currentName:t,onChooseName:e=>{r(e),m(!1)}}))]})}function p(e){var t,r,l;let{open:n,onClose:o,currentName:i,onChooseName:d}=e,[u,m]=(0,a.useState)(i),[x,p]=(0,a.useState)(0),g=c.F.exercises.searchMaster.useQuery({q:u,limit:20,cursor:null!=x?x:0},{enabled:n&&u.trim().length>0,staleTime:1e4});(0,a.useEffect)(()=>{n&&(m(i),p(0))},[n,i]);let v=null!=(l=null==(t=g.data)?void 0:t.items)?l:[],h=(null==(r=g.data)?void 0:r.nextCursor)!=null;return n?(0,s.jsx)("div",{className:"fixed inset-0 z-40 flex items-center justify-center p-4",style:{backgroundColor:"hsl(var(--foreground) / 0.5)"},children:(0,s.jsxs)("div",{className:"w-full max-w-lg rounded-lg shadow-xl",style:{backgroundColor:"var(--color-bg-surface)",border:"1px solid var(--color-border)"},children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-3",style:{borderBottom:"1px solid var(--color-border)"},children:[(0,s.jsx)("div",{className:"text-sm font-medium",style:{color:"var(--color-text)"},children:"Search exercises"}),(0,s.jsx)("button",{onClick:o,className:"rounded px-2 py-1 text-sm transition-colors",style:{color:"var(--color-text-secondary)"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--color-bg-surface)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:"Close"})]}),(0,s.jsxs)("div",{className:"p-3",children:[(0,s.jsx)("input",{value:u,onChange:e=>m(e.target.value),placeholder:"Search master exercises",className:"w-full rounded-md px-3 py-2 text-sm outline-none",style:{backgroundColor:"var(--color-bg-surface)",border:"1px solid var(--color-border)",color:"var(--color-text)"},onFocus:e=>{e.currentTarget.style.borderColor="var(--color-text-muted)"},onBlur:e=>{e.currentTarget.style.borderColor="var(--color-border)"}}),(0,s.jsx)("div",{className:"mt-3 max-h-72 overflow-y-auto rounded",style:{border:"1px solid var(--color-border)"},children:0===v.length?(0,s.jsx)("div",{className:"p-3 text-sm",style:{color:"var(--color-text-muted)"},children:"No results"}):(0,s.jsx)("ul",{children:v.map(e=>(0,s.jsxs)("li",{className:"flex items-center justify-between p-3 last:border-b-0",style:{borderBottom:"1px solid var(--color-border)"},children:[(0,s.jsx)("span",{className:"text-sm",style:{color:"var(--color-text)"},children:e.name}),(0,s.jsx)("button",{onClick:()=>d(e.name),className:"rounded px-2 py-1 text-xs transition-colors",style:{backgroundColor:"var(--color-primary)",color:"var(--btn-primary-fg)"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--color-primary-hover)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="var(--color-primary)"},children:"Use name"})]},e.id))})}),h&&(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)("button",{onClick:()=>{var e,t;let r=null!=(t=null==(e=g.data)?void 0:e.nextCursor)?t:null;p(r),null!=r&&g.refetch()},className:"w-full rounded px-3 py-2 text-sm transition-colors",style:{border:"1px solid var(--color-border)",color:"var(--color-text)"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--color-bg-surface)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:"Load more"})})]})]})}):null}var g=r(3998),v=r(65142),h=r(86948),b=r(41052);let f=i.Ik({name:i.Yj().min(1,"Template name is required").max(256,"Template name is too long"),exercises:i.YO(i.Ik({exerciseName:i.Yj().min(1,"Exercise name is required").max(256,"Exercise name is too long")})).min(1,"At least one exercise is required")});function y(e){var t;let{template:r}=e,i=(0,l.useRouter)(),u=(0,a.useRef)(!1),m=(0,a.useRef)(null),p=(0,n.mN)({resolver:(0,o.u)(f),defaultValues:{name:null!=(t=null==r?void 0:r.name)?t:"",exercises:(null==r?void 0:r.exercises.length)?r.exercises.map(e=>({exerciseName:e.exerciseName})):[{exerciseName:""}]}}),{fields:y,append:j,remove:N}=(0,n.jz)({control:p.control,name:"exercises"}),w=c.F.useUtils(),C=c.F.templates.create.useMutation({onMutate:async e=>(await w.templates.getAll.cancel(),{previousTemplates:w.templates.getAll.getData()}),onError:(e,t,r)=>{(null==r?void 0:r.previousTemplates)&&w.templates.getAll.setData(void 0,r.previousTemplates),u.current=!1},onSuccess:async e=>{console.log("Template created successfully:",{id:e.id,name:e.name,user_id:e.user_id,createdAt:e.createdAt}),d.z.templateCreated(e.id.toString(),p.getValues("exercises").filter(e=>e.exerciseName.trim()).length),u.current=!1,w.templates.getAll.setData(void 0,t=>t?[e,...t]:[e]),i.push("/templates")},onSettled:()=>{w.templates.getAll.invalidate()}}),k=c.F.templates.update.useMutation({onMutate:async e=>{await w.templates.getAll.cancel();let t=w.templates.getAll.getData();return w.templates.getAll.setData(void 0,t=>{var r;return null!=(r=null==t?void 0:t.map(t=>t.id===e.id?{...t,name:e.name,updatedAt:new Date,exercises:e.exercises.map((e,r)=>{var s,a,l,n,o,i,c,d,u,m,x,p;return{id:null!=(u=null==(a=t.exercises)||null==(s=a[r])?void 0:s.id)?u:-r-1,user_id:null!=(m=null==(n=t.exercises)||null==(l=n[r])?void 0:l.user_id)?m:"temp-user",templateId:t.id,exerciseName:e,orderIndex:r,linkingRejected:null!=(x=null==(i=t.exercises)||null==(o=i[r])?void 0:o.linkingRejected)&&x,createdAt:null!=(p=null==(d=t.exercises)||null==(c=d[r])?void 0:c.createdAt)?p:new Date}})}:t))?r:[]}),{previousTemplates:t}},onError:(e,t,r)=>{(null==r?void 0:r.previousTemplates)&&w.templates.getAll.setData(void 0,r.previousTemplates)},onSuccess:()=>{d.z.templateEdited(r.id.toString(),p.getValues("exercises").filter(e=>e.exerciseName.trim()).length),u.current=!1,i.push("/templates")},onSettled:()=>{w.templates.getAll.invalidate()}}),S=()=>{j({exerciseName:""})},D=async e=>{if(console.log("handleSubmit called"),T||u.current)return void console.log("Form already submitting, preventing double submission");let t=e.exercises.map(e=>e.exerciseName.trim()).filter(e=>""!==e),s=e.name.trim(),a=Date.now(),l=m.current;if(!r&&l){let e=a-l.timestamp;if(l.name===s&&JSON.stringify(l.exercises)===JSON.stringify(t)&&e<5e3)return void console.log("Preventing duplicate submission - same data within 5 seconds",{timeDiff:e})}u.current=!0,m.current={name:s,exercises:t,timestamp:a};try{r?await k.mutateAsync({id:r.id,name:s,exercises:t}):(console.log("Creating template with data:",{name:s,exercises:t}),await C.mutateAsync({name:s,exercises:t}))}catch(e){console.error("Error saving template:",e),d.z.error(e,{context:r?"template_edit":"template_create",templateId:null==r?void 0:r.id.toString()}),alert("Error saving template. Please try again."),u.current=!1}},T=C.isPending||k.isPending;return(0,s.jsxs)(h.Zp,{padding:"lg",children:[(0,s.jsx)(h.aR,{children:(0,s.jsx)(h.ZB,{children:r?"Edit Template":"Create Template"})}),(0,s.jsx)(h.Wu,{children:(0,s.jsx)(b.lV,{...p,children:(0,s.jsxs)("form",{onSubmit:p.handleSubmit(D),className:"space-y-6",children:[(0,s.jsx)(b.zB,{control:p.control,name:"name",render:e=>{let{field:t}=e;return(0,s.jsxs)(b.eI,{children:[(0,s.jsx)(b.lR,{children:"Template Name"}),(0,s.jsx)(b.MJ,{children:(0,s.jsx)(v.p,{placeholder:"e.g., Push Day, Pull Day, Legs",...t})}),(0,s.jsx)(b.C5,{})]})}}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,s.jsx)(b.lR,{children:"Exercises"}),(0,s.jsx)(g.Button,{type:"button",variant:"outline",size:"sm",onClick:S,children:"+ Add Exercise"})]}),(0,s.jsx)("div",{className:"space-y-3",children:y.map((e,t)=>(0,s.jsx)(b.zB,{control:p.control,name:"exercises.".concat(t,".exerciseName"),render:e=>{let{field:r}=e;return(0,s.jsxs)(b.eI,{children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)(b.MJ,{children:(0,s.jsx)(x,{value:r.value,onChange:r.onChange,placeholder:"Exercise ".concat(t+1),className:"w-full"})})}),y.length>1&&(0,s.jsx)(g.Button,{type:"button",variant:"ghost",size:"sm",onClick:()=>{N(t)},className:"text-destructive hover:text-destructive hover:bg-destructive/10",children:"Remove"})]}),(0,s.jsx)(b.C5,{})]})}},e.id))}),0===y.length&&(0,s.jsx)(g.Button,{type:"button",variant:"outline",onClick:S,className:"h-20 w-full border-dashed",children:"+ Add your first exercise"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-4 pt-4",children:[(0,s.jsx)(g.Button,{type:"submit",disabled:T||u.current,children:T||u.current?"Saving...":r?"Update Template":"Create Template"}),(0,s.jsx)(g.Button,{type:"button",variant:"ghost",onClick:()=>i.back(),children:"Cancel"})]})]})})})]})}}}]);